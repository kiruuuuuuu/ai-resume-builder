{% extends 'base.html' %}

{% block title %}Parsing Your Resume...{% endblock %}

{% block content %}
<style>
    @keyframes typing {
        0%, 100% { content: ''; }
        25% { content: '.'; }
        50% { content: '..'; }
        75% { content: '...'; }
    }
    
    @keyframes scanning {
        0% { transform: translateX(-100%); }
        50% { transform: translateX(100%); }
        100% { transform: translateX(-100%); }
    }
    
    .typing-ellipsis::after {
        content: '';
        animation: typing 1.5s infinite;
    }
    
    .scanning-bar {
        position: relative;
        overflow: hidden;
        height: 4px;
        background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.5), transparent);
    }
    
    .scanning-bar::after {
        content: '';
        position: absolute;
        width: 50%;
        height: 100%;
        background: linear-gradient(90deg, transparent, #6366f1, transparent);
        animation: scanning 2s infinite;
    }
</style>

<div class="max-w-2xl mx-auto py-20 px-4 text-center" x-data="parsingProgress()" role="status" aria-live="polite">
    <div class="flex flex-col items-center mb-8 animate-fade-in-up">
        <div class="relative mb-8">
            <div class="spinner-lg"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <svg class="h-10 w-10 text-indigo-600 animate-pulse-custom" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </div>
        </div>
        
        <!-- Scanning Bar Animation -->
        <div class="w-full max-w-md mb-6">
            <div class="scanning-bar rounded-full"></div>
        </div>
        
        <!-- Progress Percentage -->
        <div class="mb-4" x-show="estimatedProgress > 0" x-cloak>
            <div class="text-sm text-gray-600 mb-1">Estimated Progress</div>
            <div class="w-full max-w-md bg-gray-200 rounded-full h-3">
                <div class="bg-indigo-600 h-3 rounded-full transition-all duration-500" :style="'width: ' + estimatedProgress + '%'"></div>
            </div>
            <div class="text-xs text-gray-500 mt-1" x-text="estimatedProgress + '%'"></div>
        </div>
    </div>
    
    <h1 class="text-3xl font-bold text-gray-800 mb-2 animate-fade-in-up delay-100">
        Parsing in Progress<span class="typing-ellipsis"></span>
    </h1>
    <p class="text-lg text-gray-600 mt-4 animate-fade-in-up delay-200">
        Our AI is analyzing your resume. This may take a moment<span class="typing-ellipsis"></span>
    </p>
    <p class="text-sm text-gray-500 mt-2 animate-fade-in-up delay-300" x-text="timeRemaining ? 'Estimated time remaining: ' + timeRemaining : 'Please wait, you will be redirected automatically.'"></p>
    
    <div class="mt-8 animate-fade-in-up delay-400">
        <button @click="cancelParsing()" 
                class="btn-secondary"
                aria-label="Cancel resume parsing">
            Cancel
        </button>
    </div>
</div>

<script>
function parsingProgress() {
    return {
        estimatedProgress: 0,
        startTime: Date.now(),
        timeRemaining: '',
        init() {
            // Simulate progress animation
            const interval = setInterval(() => {
                const elapsed = (Date.now() - this.startTime) / 1000;
                if (elapsed < 30) {
                    this.estimatedProgress = Math.min(Math.round((elapsed / 30) * 90), 90);
                    const remaining = Math.max(Math.round(30 - elapsed), 0);
                    this.timeRemaining = remaining > 0 ? remaining + ' seconds' : '';
                } else {
                    this.estimatedProgress = 90;
                    this.timeRemaining = 'Almost done...';
                }
            }, 500);
            
            this.checkStatus();
        },
        checkStatus() {
            fetch("{% url 'resumes:check-parsing-status' %}")
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'SUCCESS') {
                        this.estimatedProgress = 100;
                        setTimeout(() => {
                            window.location.href = data.redirect_url;
                        }, 500);
                    } else if (data.status === 'PENDING') {
                        setTimeout(() => this.checkStatus(), 2000);
                    } else {
                        alert("An error occurred during parsing. Please try uploading again.");
                        window.location.href = "{% url 'resumes:resume-dashboard' %}";
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                    setTimeout(() => this.checkStatus(), 5000);
                });
        },
        cancelParsing() {
            if (confirm('Are you sure you want to cancel? Your resume parsing will be stopped.')) {
                window.location.href = "{% url 'resumes:resume-dashboard' %}";
            }
        }
    }
}
</script>
{% endblock %}

