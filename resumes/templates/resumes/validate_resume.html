{% extends 'base.html' %}
{% load crispy_forms_tags custom_filters %}

{% block title %}Confirm Your Details{% endblock %}

{% block extra_css %}
<style>
    @keyframes scale-in {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    .animate-scale-in {
        animation: scale-in 0.3s ease-out;
    }
    
    .error-field {
        animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
        20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    .hover\:shadow-3xl:hover {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<!-- Enhanced Hero Section -->
<div class="relative bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 overflow-hidden">
    <div class="absolute inset-0 bg-black opacity-10"></div>
    <div class="absolute inset-0" style="background-image: url('data:image/svg+xml,%3Csvg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cg fill=\"%23ffffff\" fill-opacity=\"0.05\"%3E%3Cpath d=\"M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
    <div class="relative max-w-7xl mx-auto px-4 py-16 text-center">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-white/20 backdrop-blur-sm rounded-2xl mb-6">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <h1 class="text-5xl md:text-6xl font-bold text-white mb-4 animate-fade-in-up drop-shadow-lg">
            Confirm Your Details
        </h1>
        <p class="text-xl text-indigo-100 mb-8 animate-fade-in-up delay-100">
            Our AI has extracted the following information. Please review, correct, and add any missing details before saving.
        </p>
    </div>
</div>

<div class="max-w-4xl mx-auto py-12 px-4 -mt-8" x-data="formsetManager()">

    <!-- Enhanced Sticky Navigation Bar with Visual Error Indicators -->
    <nav class="sticky top-16 z-30 bg-white/95 backdrop-blur-lg shadow-2xl rounded-2xl mb-8 px-6 py-5 border-2 border-gray-200/60" style="scroll-margin-top: 1rem;">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wider">Quick Navigation</h3>
            <div class="flex items-center gap-2 text-xs text-gray-500">
                <div class="flex items-center gap-1">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span>Complete</span>
                </div>
                <div class="flex items-center gap-1">
                    <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <span>Errors</span>
                </div>
            </div>
        </div>
        <div class="flex flex-wrap justify-center gap-2 md:gap-3 text-sm">
            <a href="#formset-personal" @click.prevent="scrollToSection('personal')" class="relative px-4 py-2.5 rounded-xl text-gray-700 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 hover:text-indigo-700 transition-all duration-200 font-medium shadow-sm hover:shadow-md {% if profile_form.errors %}font-semibold text-white bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-400 shadow-lg hover:from-red-600 hover:to-red-700{% else %}bg-gray-50{% endif %}">
                Personal
                {% if profile_form.errors %}
                    <span class="absolute -top-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center border-2 border-red-600 shadow-lg">
                        <span class="text-xs font-bold text-red-600">{{ profile_form.errors|length }}</span>
                    </span>
                {% endif %}
            </a>
            <a href="#formset-experience" @click.prevent="scrollToSection('experience')" class="relative px-4 py-2.5 rounded-xl text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-all duration-200 font-medium shadow-sm hover:shadow-md {% if experience_formset.errors or experience_formset.non_form_errors %}font-semibold text-white bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-400 shadow-lg{% else %}bg-gray-50{% endif %}">
                Experience
                {% if experience_formset.errors or experience_formset.non_form_errors %}
                    <span class="absolute -top-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center border-2 border-red-600 shadow-lg">
                        <span class="text-xs font-bold text-red-600">!</span>
                    </span>
                {% endif %}
            </a>
            <a href="#formset-education" @click.prevent="scrollToSection('education')" class="relative px-4 py-2.5 rounded-xl text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-all duration-200 font-medium shadow-sm hover:shadow-md {% if education_formset.errors or education_formset.non_form_errors %}font-semibold text-white bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-400 shadow-lg{% else %}bg-gray-50{% endif %}">
                Education
                {% if education_formset.errors or education_formset.non_form_errors %}
                    <span class="absolute -top-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center border-2 border-red-600 shadow-lg">
                        <span class="text-xs font-bold text-red-600">!</span>
                    </span>
                {% endif %}
            </a>
            <a href="#formset-skill" @click.prevent="scrollToSection('skill')" class="relative px-4 py-2.5 rounded-xl text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-all duration-200 font-medium shadow-sm hover:shadow-md {% if skill_formset.errors or skill_formset.non_form_errors %}font-semibold text-white bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-400 shadow-lg{% else %}bg-gray-50{% endif %}">
                Skills
                {% if skill_formset.errors or skill_formset.non_form_errors %}
                    <span class="absolute -top-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center border-2 border-red-600 shadow-lg animate-pulse">
                        <span class="text-xs font-bold text-red-600">!</span>
                    </span>
                {% endif %}
            </a>
            <a href="#formset-project" @click.prevent="scrollToSection('project')" class="relative px-4 py-2.5 rounded-xl text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-all duration-200 font-medium shadow-sm hover:shadow-md {% if project_formset.errors or project_formset.non_form_errors %}font-semibold text-white bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-400 shadow-lg{% else %}bg-gray-50{% endif %}">
                Projects
                {% if project_formset.errors or project_formset.non_form_errors %}
                    <span class="absolute -top-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center border-2 border-red-600 shadow-lg">
                        <span class="text-xs font-bold text-red-600">!</span>
                    </span>
                {% endif %}
            </a>
            <a href="#formset-certification" @click.prevent="scrollToSection('certification')" class="relative px-4 py-2.5 rounded-xl text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-all duration-200 font-medium shadow-sm hover:shadow-md {% if certification_formset.errors or certification_formset.non_form_errors %}font-semibold text-white bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-400 shadow-lg{% else %}bg-gray-50{% endif %}">
                Certifications
                {% if certification_formset.errors or certification_formset.non_form_errors %}
                    <span class="absolute -top-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center border-2 border-red-600 shadow-lg">
                        <span class="text-xs font-bold text-red-600">!</span>
                    </span>
                {% endif %}
            </a>
            <a href="#formset-achievement" @click.prevent="scrollToSection('achievement')" class="relative px-4 py-2.5 rounded-xl text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-all duration-200 font-medium shadow-sm hover:shadow-md {% if achievement_formset.errors or achievement_formset.non_form_errors %}font-semibold text-white bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-400 shadow-lg{% else %}bg-gray-50{% endif %}">
                Achievements
                {% if achievement_formset.errors or achievement_formset.non_form_errors %}
                    <span class="absolute -top-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center border-2 border-red-600 shadow-lg">
                        <span class="text-xs font-bold text-red-600">!</span>
                    </span>
                {% endif %}
            </a>
            <a href="#formset-language" @click.prevent="scrollToSection('language')" class="relative px-4 py-2.5 rounded-xl text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-all duration-200 font-medium shadow-sm hover:shadow-md {% if language_formset.errors or language_formset.non_form_errors %}font-semibold text-white bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-400 shadow-lg{% else %}bg-gray-50{% endif %}">
                Languages
                {% if language_formset.errors or language_formset.non_form_errors %}
                    <span class="absolute -top-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center border-2 border-red-600 shadow-lg">
                        <span class="text-xs font-bold text-red-600">!</span>
                    </span>
                {% endif %}
            </a>
            <a href="#formset-hobby" @click.prevent="scrollToSection('hobby')" class="relative px-4 py-2.5 rounded-xl text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-all duration-200 font-medium shadow-sm hover:shadow-md {% if hobby_formset.errors or hobby_formset.non_form_errors %}font-semibold text-white bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-400 shadow-lg{% else %}bg-gray-50{% endif %}">
                Hobbies
                {% if hobby_formset.errors or hobby_formset.non_form_errors %}
                    <span class="absolute -top-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center border-2 border-red-600 shadow-lg">
                        <span class="text-xs font-bold text-red-600">!</span>
                    </span>
                {% endif %}
            </a>
        </div>
    </nav>

    <!-- Enhanced Error Summary (shown when form has errors) -->
    {% if profile_form.errors or experience_formset.errors or education_formset.errors or skill_formset.errors or project_formset.errors or certification_formset.errors or achievement_formset.errors or language_formset.errors or hobby_formset.errors %}
    <div id="error-summary" class="mb-8 relative overflow-hidden rounded-2xl shadow-2xl border-2 border-red-300 bg-gradient-to-br from-red-50 via-red-50/95 to-orange-50/50 animate-scale-in">
        <!-- Animated background pattern -->
        <div class="absolute inset-0 opacity-5">
            <div class="absolute inset-0" style="background-image: url('data:image/svg+xml,%3Csvg width=\"40\" height=\"40\" viewBox=\"0 0 40 40\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"%23dc2626\" fill-opacity=\"0.4\"%3E%3Cpath d=\"M20 20.5V18H0v-2h20v-2H0v-2h20v-2H0V8h20V6H0V4h20V2H0V0h20v20h20V0h2v20h2v20h-2v2h-2v2h-2v-2h-2v-2h2v-2h2v-2h-2v-2h-2V20.5zM0 20h2v20H0V20zm40 0v20h-2V20h2zM20 0h2v20h-2V0zm0 40v-2h2v2h-2z\"/%3E%3C/g%3E%3C/svg%3E');"></div>
        </div>
        
        <!-- Pulsing border animation -->
        <div class="absolute inset-0 rounded-2xl border-2 border-red-400 animate-pulse opacity-50"></div>
        
        <div class="relative p-8">
            <div class="flex items-start gap-4">
                <!-- Large animated icon -->
                <div class="flex-shrink-0">
                    <div class="relative">
                        <div class="absolute inset-0 bg-red-500 rounded-full animate-ping opacity-20"></div>
                        <div class="relative w-16 h-16 bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center shadow-xl">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-2xl font-bold text-red-900 mb-1 flex items-center gap-2">
                                <span>Validation Errors Detected</span>
                                <span class="px-3 py-1 bg-red-600 text-white text-sm font-bold rounded-full shadow-lg">
                                    {% if profile_form.errors %}{{ profile_form.errors|length }}{% endif %}
                                    {% if skill_formset.errors %}{{ skill_formset.errors|length }}{% endif %}
                                </span>
                            </h3>
                            <p class="text-red-700 text-sm">Please review and correct the following issues before proceeding:</p>
                        </div>
                        <button onclick="document.getElementById('error-summary').scrollIntoView({behavior: 'smooth'})" class="flex-shrink-0 p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors" aria-label="Scroll to top">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                            </svg>
                        </button>
                    </div>
                    
                    <div class="bg-white/80 backdrop-blur-sm rounded-xl p-6 border border-red-200/50 shadow-inner">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% if profile_form.errors %}
                                <div class="space-y-2">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                                        <span class="font-bold text-red-900 text-sm uppercase tracking-wide">Personal Details</span>
                                    </div>
                                    {% for field, errors in profile_form.errors.items %}
                                        {% for error in errors %}
                                            <div class="ml-4 p-3 bg-red-50 border-l-4 border-red-500 rounded-r-lg hover:bg-red-100 transition-colors cursor-pointer" onclick="scrollToField('{{ field }}')">
                                                <div class="flex items-start gap-2">
                                                    <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                    </svg>
                                                    <div>
                                                        <span class="font-semibold text-red-900">{{ field|title|replace:"_":" " }}:</span>
                                                        <span class="text-red-700 ml-1">{{ error }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if experience_formset.errors %}
                                <div class="space-y-2">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                                        <span class="font-bold text-red-900 text-sm uppercase tracking-wide">Experience</span>
                                    </div>
                                    {% for form in experience_formset %}
                                        {% if form.errors %}
                                            {% for field, errors in form.errors.items %}
                                                {% for error in errors %}
                                                    <div class="ml-4 p-3 bg-red-50 border-l-4 border-red-500 rounded-r-lg hover:bg-red-100 transition-colors">
                                                        <div class="flex items-start gap-2">
                                                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                            </svg>
                                                            <div>
                                                                <span class="font-semibold text-red-900">Experience {{ forloop.parentloop.counter }} - {{ field|title|replace:"_":" " }}:</span>
                                                                <span class="text-red-700 ml-1">{{ error }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if education_formset.errors %}
                                <div class="space-y-2">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                                        <span class="font-bold text-red-900 text-sm uppercase tracking-wide">Education</span>
                                    </div>
                                    {% for form in education_formset %}
                                        {% if form.errors %}
                                            {% for field, errors in form.errors.items %}
                                                {% for error in errors %}
                                                    <div class="ml-4 p-3 bg-red-50 border-l-4 border-red-500 rounded-r-lg hover:bg-red-100 transition-colors">
                                                        <div class="flex items-start gap-2">
                                                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                            </svg>
                                                            <div>
                                                                <span class="font-semibold text-red-900">Education {{ forloop.parentloop.counter }} - {{ field|title|replace:"_":" " }}:</span>
                                                                <span class="text-red-700 ml-1">{{ error }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if skill_formset.errors %}
                                <div class="space-y-2">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                                        <span class="font-bold text-red-900 text-sm uppercase tracking-wide">Skills</span>
                                    </div>
                                    {% for form in skill_formset %}
                                        {% if form.errors %}
                                            {% for field, errors in form.errors.items %}
                                                {% for error in errors %}
                                                    <div class="ml-4 p-3 bg-red-50 border-l-4 border-red-500 rounded-r-lg hover:bg-red-100 transition-colors cursor-pointer" onclick="scrollToSection('skill')">
                                                        <div class="flex items-start gap-2">
                                                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                            </svg>
                                                            <div>
                                                                <span class="font-semibold text-red-900">Skill {{ forloop.parentloop.counter }} - {{ field|title|replace:"_":" " }}:</span>
                                                                <span class="text-red-700 ml-1">{{ error }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if project_formset.errors %}
                                <div class="space-y-2">
                                    <div class="flex items-center gap-2 mb-2">
                                        <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                                        <span class="font-bold text-red-900 text-sm uppercase tracking-wide">Projects</span>
                                    </div>
                                    {% for form in project_formset %}
                                        {% if form.errors %}
                                            {% for field, errors in form.errors.items %}
                                                {% for error in errors %}
                                                    <div class="ml-4 p-3 bg-red-50 border-l-4 border-red-500 rounded-r-lg hover:bg-red-100 transition-colors">
                                                        <div class="flex items-start gap-2">
                                                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                            </svg>
                                                            <div>
                                                                <span class="font-semibold text-red-900">Project {{ forloop.parentloop.counter }} - {{ field|title|replace:"_":" " }}:</span>
                                                                <span class="text-red-700 ml-1">{{ error }}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if certification_formset.errors or achievement_formset.errors or language_formset.errors or hobby_formset.errors %}
                                <div class="space-y-2">
                                    {% if certification_formset.errors %}
                                        <div class="flex items-center gap-2 mb-2">
                                            <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                                            <span class="font-bold text-red-900 text-sm uppercase tracking-wide">Certifications</span>
                                        </div>
                                        {% for form in certification_formset %}
                                            {% if form.errors %}
                                                {% for field, errors in form.errors.items %}
                                                    {% for error in errors %}
                                                        <div class="ml-4 p-3 bg-red-50 border-l-4 border-red-500 rounded-r-lg hover:bg-red-100 transition-colors">
                                                            <div class="flex items-start gap-2">
                                                                <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                                </svg>
                                                                <div>
                                                                    <span class="font-semibold text-red-900">Certification {{ forloop.parentloop.counter }} - {{ field|title|replace:"_":" " }}:</span>
                                                                    <span class="text-red-700 ml-1">{{ error }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if achievement_formset.errors %}
                                        <div class="flex items-center gap-2 mb-2 mt-4">
                                            <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                                            <span class="font-bold text-red-900 text-sm uppercase tracking-wide">Achievements</span>
                                        </div>
                                        {% for form in achievement_formset %}
                                            {% if form.errors %}
                                                {% for field, errors in form.errors.items %}
                                                    {% for error in errors %}
                                                        <div class="ml-4 p-3 bg-red-50 border-l-4 border-red-500 rounded-r-lg hover:bg-red-100 transition-colors">
                                                            <div class="flex items-start gap-2">
                                                                <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                                </svg>
                                                                <div>
                                                                    <span class="font-semibold text-red-900">Achievement {{ forloop.parentloop.counter }} - {{ field|title|replace:"_":" " }}:</span>
                                                                    <span class="text-red-700 ml-1">{{ error }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if language_formset.errors %}
                                        <div class="flex items-center gap-2 mb-2 mt-4">
                                            <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                                            <span class="font-bold text-red-900 text-sm uppercase tracking-wide">Languages</span>
                                        </div>
                                        {% for form in language_formset %}
                                            {% if form.errors %}
                                                {% for field, errors in form.errors.items %}
                                                    {% for error in errors %}
                                                        <div class="ml-4 p-3 bg-red-50 border-l-4 border-red-500 rounded-r-lg hover:bg-red-100 transition-colors">
                                                            <div class="flex items-start gap-2">
                                                                <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                                </svg>
                                                                <div>
                                                                    <span class="font-semibold text-red-900">Language {{ forloop.parentloop.counter }} - {{ field|title|replace:"_":" " }}:</span>
                                                                    <span class="text-red-700 ml-1">{{ error }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {% if hobby_formset.errors %}
                                        <div class="flex items-center gap-2 mb-2 mt-4">
                                            <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                                            <span class="font-bold text-red-900 text-sm uppercase tracking-wide">Hobbies</span>
                                        </div>
                                        {% for form in hobby_formset %}
                                            {% if form.errors %}
                                                {% for field, errors in form.errors.items %}
                                                    {% for error in errors %}
                                                        <div class="ml-4 p-3 bg-red-50 border-l-4 border-red-500 rounded-r-lg hover:bg-red-100 transition-colors">
                                                            <div class="flex items-start gap-2">
                                                                <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                                </svg>
                                                                <div>
                                                                    <span class="font-semibold text-red-900">Hobby {{ forloop.parentloop.counter }} - {{ field|title|replace:"_":" " }}:</span>
                                                                    <span class="text-red-700 ml-1">{{ error }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <form id="validate-resume-form" method="POST" enctype="multipart/form-data" class="space-y-4" novalidate>
        {% csrf_token %}

        <!-- Personal Information -->
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl transition-all duration-300 border-2 {% if profile_form.errors %}border-red-400 bg-gradient-to-br from-red-50/30 to-white{% else %}border-gray-200/60{% endif %} hover:shadow-3xl hover:border-indigo-300 mb-6 overflow-hidden">
            <!-- Error indicator bar -->
            {% if profile_form.errors %}
            <div class="h-1.5 bg-gradient-to-r from-red-500 via-red-600 to-red-500 animate-pulse"></div>
            {% endif %}
            <button type="button" @click="toggleSection('personal')" class="w-full text-left p-6 hover:bg-gradient-to-r hover:from-indigo-50/50 hover:to-purple-50/50 transition-all duration-200 rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-x-3">
                        <div class="relative p-3 bg-gradient-to-br {% if profile_form.errors %}from-red-500 to-red-600{% else %}from-indigo-500 to-purple-600{% endif %} rounded-xl shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            {% if profile_form.errors %}
                                <div class="absolute -top-1 -right-1 w-6 h-6 bg-white rounded-full flex items-center justify-center border-2 border-red-600 shadow-lg">
                                    <span class="text-xs font-bold text-red-600">{{ profile_form.errors|length }}</span>
                                </div>
                            {% endif %}
                        </div>
                        <span>Personal Details</span>
                        {% if profile_form.errors %}
                            <span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full shadow-lg animate-pulse">Errors</span>
                        {% endif %}
                    </h2>
                    <svg class="w-6 h-6 transform transition-transform text-gray-400" :class="{'rotate-180': openSection === 'personal'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
            </button>
            <div x-show="openSection === 'personal'" x-cloak x-transition class="p-6 border-t border-gray-200" id="formset-personal">
                {% if profile_form.non_field_errors %}
                    <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Form Errors</h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <ul class="list-disc list-inside">
                                        {% for error in profile_form.non_field_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
                {% for field in profile_form.visible_fields %}
                    <div class="mb-5 {% if field.errors %}error-field{% endif %}">
                        <div class="{% if field.errors %}p-4 bg-red-50 border-2 border-red-300 rounded-xl shadow-md{% endif %}">
                            {{ field|as_crispy_field }}
                            {% if field.errors %}
                                <div class="mt-3 p-3 bg-white border-l-4 border-red-500 rounded-r-lg shadow-sm">
                                    {% for error in field.errors %}
                                        <div class="flex items-start gap-2 mb-2 last:mb-0">
                                            <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                            </svg>
                                            <span class="text-sm font-medium text-red-800">{{ error }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% if field.name == 'professional_summary' %}
                        <div class="flex justify-end -mt-2 mb-4">
                            <button type="button" class="enhance-btn text-sm font-medium text-purple-600 hover:text-purple-800" 
                                    data-enhance-target="{{ field.id_for_label }}" 
                                    data-enhance-context="professional_summary">✨ Enhance with AI</button>
                        </div>
                    {% endif %}
                {% endfor %}
                {% for field in profile_form.hidden_fields %}{{ field }}{% endfor %}
            </div>
        </div>

        <!-- Experience -->
        <div class="bg-white rounded-2xl shadow-xl transition-all duration-300 border-2 {% if experience_formset.non_form_errors or experience_formset.errors|HasErrors %}border-red-400 bg-gradient-to-br from-red-50/30 to-white{% else %}border-gray-200{% endif %} hover:shadow-2xl mb-6 overflow-hidden">
            {% if experience_formset.non_form_errors or experience_formset.errors|HasErrors %}
            <div class="h-1.5 bg-gradient-to-r from-red-500 via-red-600 to-red-500"></div>
            {% endif %}
            <button type="button" @click="toggleSection('experience')" class="w-full text-left p-6 hover:bg-gradient-to-r hover:from-indigo-50/50 hover:to-purple-50/50 transition-all duration-200">
                <div class="flex justify-between items-center">
                     <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-x-3">
                        <div class="p-2.5 bg-gradient-to-br {% if experience_formset.non_form_errors or experience_formset.errors|HasErrors %}from-red-500 to-red-600{% else %}from-blue-500 to-blue-600{% endif %} rounded-xl shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <span>Experience</span>
                        {% if experience_formset.non_form_errors or experience_formset.errors|HasErrors %}
                            <span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full shadow-lg">Errors</span>
                        {% endif %}
                    </h2>
                    <svg class="w-6 h-6 transform transition-transform text-gray-400" :class="{'rotate-180': openSection === 'experience'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
            </button>
            <div x-show="openSection === 'experience'" x-cloak x-transition class="p-6 border-t" id="formset-experience">
                {{ experience_formset.management_form }}
                {% if experience_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ experience_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-experience">
                    {% for form in experience_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-experience">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'experience')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}
                            {{ field|as_crispy_field }}
                            {% if field.name == 'description' %}
                                <div class="flex justify-end -mt-2 mb-4">
                                    <button type="button" class="enhance-btn text-sm font-medium text-purple-600 hover:text-purple-800"
                                            data-enhance-target="{{ field.id_for_label }}"
                                            data-enhance-context="experience_description">✨ Enhance with AI</button>
                                </div>
                            {% endif %}
                        {% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div>
                <button type="button" @click="addForm('experience')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Experience</button>
            </div>
        </div>

        <!-- Education -->
        <div class="bg-white rounded-2xl shadow-xl transition-all duration-300 border-2 {% if education_formset.non_form_errors or education_formset.errors|HasErrors %}border-red-400 bg-gradient-to-br from-red-50/30 to-white{% else %}border-gray-200{% endif %} hover:shadow-2xl mb-6 overflow-hidden">
            {% if education_formset.non_form_errors or education_formset.errors|HasErrors %}
            <div class="h-1.5 bg-gradient-to-r from-red-500 via-red-600 to-red-500"></div>
            {% endif %}
            <button type="button" @click="toggleSection('education')" class="w-full text-left p-6 hover:bg-gradient-to-r hover:from-indigo-50/50 hover:to-purple-50/50 transition-all duration-200">
                 <div class="flex justify-between items-center">
                     <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-x-3">
                         <div class="p-2.5 bg-gradient-to-br {% if education_formset.non_form_errors or education_formset.errors|HasErrors %}from-red-500 to-red-600{% else %}from-emerald-500 to-emerald-600{% endif %} rounded-xl shadow-lg">
                             <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z" />
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l0 7" />
                             </svg>
                         </div>
                         <span>Education</span>
                         {% if education_formset.non_form_errors or education_formset.errors|HasErrors %}
                             <span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full shadow-lg">Errors</span>
                         {% endif %}
                     </h2>
                     <svg class="w-6 h-6 transform transition-transform text-gray-400" :class="{'rotate-180': openSection === 'education'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                 </div>
            </button>
            <div x-show="openSection === 'education'" x-cloak x-transition class="p-6 border-t" id="formset-education">
                {{ education_formset.management_form }}
                {% if education_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ education_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-education">
                    {% for form in education_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-education">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'education')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div><button type="button" @click="addForm('education')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Education</button>
            </div>
        </div>

        <!-- Projects -->
         <div class="bg-white rounded-2xl shadow-xl transition-all duration-300 border-2 {% if project_formset.non_form_errors or project_formset.errors|HasErrors %}border-red-400 bg-gradient-to-br from-red-50/30 to-white{% else %}border-gray-200{% endif %} hover:shadow-2xl mb-6 overflow-hidden">
            {% if project_formset.non_form_errors or project_formset.errors|HasErrors %}
            <div class="h-1.5 bg-gradient-to-r from-red-500 via-red-600 to-red-500"></div>
            {% endif %}
            <button type="button" @click="toggleSection('project')" class="w-full text-left p-6 hover:bg-gradient-to-r hover:from-indigo-50/50 hover:to-purple-50/50 transition-all duration-200">
                 <div class="flex justify-between items-center">
                     <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-x-3">
                         <div class="p-2.5 bg-gradient-to-br {% if project_formset.non_form_errors or project_formset.errors|HasErrors %}from-red-500 to-red-600{% else %}from-purple-500 to-purple-600{% endif %} rounded-xl shadow-lg">
                             <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                             </svg>
                         </div>
                         <span>Projects</span>
                         {% if project_formset.non_form_errors or project_formset.errors|HasErrors %}
                             <span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full shadow-lg">Errors</span>
                         {% endif %}
                     </h2>
                     <svg class="w-6 h-6 transform transition-transform text-gray-400" :class="{'rotate-180': openSection === 'project'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                 </div>
            </button>
            <div x-show="openSection === 'project'" x-cloak x-transition class="p-6 border-t" id="formset-project">
                {{ project_formset.management_form }}
                {% if project_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ project_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-project">
                    {% for form in project_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-project">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'project')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}
                            {{ field|as_crispy_field }}
                            {% if field.name == 'description' %}
                                <div class="flex justify-end -mt-2 mb-4">
                                    <button type="button" class="enhance-btn text-sm font-medium text-purple-600 hover:text-purple-800"
                                            data-enhance-target="{{ field.id_for_label }}"
                                            data-enhance-context="experience_description">✨ Enhance with AI</button>
                                </div>
                            {% endif %}
                        {% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div><button type="button" @click="addForm('project')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Project</button>
            </div>
        </div>

        <!-- Certifications -->
        <div class="bg-white rounded-2xl shadow-xl transition-all duration-300 border-2 {% if certification_formset.non_form_errors or certification_formset.errors|HasErrors %}border-red-400 bg-gradient-to-br from-red-50/30 to-white{% else %}border-gray-200{% endif %} hover:shadow-2xl mb-6 overflow-hidden">
            {% if certification_formset.non_form_errors or certification_formset.errors|HasErrors %}
            <div class="h-1.5 bg-gradient-to-r from-red-500 via-red-600 to-red-500"></div>
            {% endif %}
            <button type="button" @click="toggleSection('certification')" class="w-full text-left p-6 hover:bg-gradient-to-r hover:from-indigo-50/50 hover:to-purple-50/50 transition-all duration-200">
                 <div class="flex justify-between items-center">
                     <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-x-3">
                         <div class="p-2.5 bg-gradient-to-br {% if certification_formset.non_form_errors or certification_formset.errors|HasErrors %}from-red-500 to-red-600{% else %}from-teal-500 to-teal-600{% endif %} rounded-xl shadow-lg">
                             <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                             </svg>
                         </div>
                         <span>Certifications</span>
                         {% if certification_formset.non_form_errors or certification_formset.errors|HasErrors %}
                             <span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full shadow-lg">Errors</span>
                         {% endif %}
                     </h2>
                     <svg class="w-6 h-6 transform transition-transform text-gray-400" :class="{'rotate-180': openSection === 'certification'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                 </div>
            </button>
            <div x-show="openSection === 'certification'" x-cloak x-transition class="p-6 border-t" id="formset-certification">
                {{ certification_formset.management_form }}
                {% if certification_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ certification_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-certification">
                    {% for form in certification_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-certification">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'certification')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div><button type="button" @click="addForm('certification')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Certification</button>
            </div>
        </div>

        <!-- Achievements -->
        <div class="bg-white rounded-2xl shadow-xl transition-all duration-300 border-2 {% if achievement_formset.non_form_errors or achievement_formset.errors|HasErrors %}border-red-400 bg-gradient-to-br from-red-50/30 to-white{% else %}border-gray-200{% endif %} hover:shadow-2xl mb-6 overflow-hidden">
            {% if achievement_formset.non_form_errors or achievement_formset.errors|HasErrors %}
            <div class="h-1.5 bg-gradient-to-r from-red-500 via-red-600 to-red-500"></div>
            {% endif %}
            <button type="button" @click="toggleSection('achievement')" class="w-full text-left p-6 hover:bg-gradient-to-r hover:from-indigo-50/50 hover:to-purple-50/50 transition-all duration-200">
                 <div class="flex justify-between items-center">
                     <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-x-3">
                         <div class="p-2.5 bg-gradient-to-br {% if achievement_formset.non_form_errors or achievement_formset.errors|HasErrors %}from-red-500 to-red-600{% else %}from-yellow-500 to-yellow-600{% endif %} rounded-xl shadow-lg">
                             <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                             </svg>
                         </div>
                         <span>Achievements</span>
                         {% if achievement_formset.non_form_errors or achievement_formset.errors|HasErrors %}
                             <span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full shadow-lg">Errors</span>
                         {% endif %}
                     </h2>
                     <svg class="w-6 h-6 transform transition-transform text-gray-400" :class="{'rotate-180': openSection === 'achievement'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                 </div>
            </button>
            <div x-show="openSection === 'achievement'" x-cloak x-transition class="p-6 border-t" id="formset-achievement">
                {{ achievement_formset.management_form }}
                {% if achievement_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ achievement_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-achievement">
                    {% for form in achievement_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-achievement">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'achievement')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}
                            {{ field|as_crispy_field }}
                            {% if field.name == 'description' %}
                                <div class="flex justify-end -mt-2 mb-4">
                                    <button type="button" class="enhance-btn text-sm font-medium text-purple-600 hover:text-purple-800"
                                            data-enhance-target="{{ field.id_for_label }}"
                                            data-enhance-context="experience_description">✨ Enhance with AI</button>
                                </div>
                            {% endif %}
                        {% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div><button type="button" @click="addForm('achievement')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Achievement</button>
            </div>
        </div>

        <!-- Languages -->
        <div class="bg-white rounded-2xl shadow-xl transition-all duration-300 border-2 {% if language_formset.non_form_errors or language_formset.errors|HasErrors %}border-red-400 bg-gradient-to-br from-red-50/30 to-white{% else %}border-gray-200{% endif %} hover:shadow-2xl mb-6 overflow-hidden">
            {% if language_formset.non_form_errors or language_formset.errors|HasErrors %}
            <div class="h-1.5 bg-gradient-to-r from-red-500 via-red-600 to-red-500"></div>
            {% endif %}
            <button type="button" @click="toggleSection('language')" class="w-full text-left p-6 hover:bg-gradient-to-r hover:from-indigo-50/50 hover:to-purple-50/50 transition-all duration-200">
                 <div class="flex justify-between items-center">
                     <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-x-3">
                         <div class="p-2.5 bg-gradient-to-br {% if language_formset.non_form_errors or language_formset.errors|HasErrors %}from-red-500 to-red-600{% else %}from-cyan-500 to-cyan-600{% endif %} rounded-xl shadow-lg">
                             <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                             </svg>
                         </div>
                         <span>Languages</span>
                         {% if language_formset.non_form_errors or language_formset.errors|HasErrors %}
                             <span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full shadow-lg">Errors</span>
                         {% endif %}
                     </h2>
                     <svg class="w-6 h-6 transform transition-transform text-gray-400" :class="{'rotate-180': openSection === 'language'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                 </div>
            </button>
            <div x-show="openSection === 'language'" x-cloak x-transition class="p-6 border-t" id="formset-language">
                {{ language_formset.management_form }}
                {% if language_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ language_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-language">
                    {% for form in language_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-language">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'language')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div><button type="button" @click="addForm('language')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Language</button>
            </div>
        </div>

        <!-- Hobbies -->
        <div class="bg-white rounded-2xl shadow-xl transition-all duration-300 border-2 {% if hobby_formset.non_form_errors or hobby_formset.errors|HasErrors %}border-red-400 bg-gradient-to-br from-red-50/30 to-white{% else %}border-gray-200{% endif %} hover:shadow-2xl mb-6 overflow-hidden">
            {% if hobby_formset.non_form_errors or hobby_formset.errors|HasErrors %}
            <div class="h-1.5 bg-gradient-to-r from-red-500 via-red-600 to-red-500"></div>
            {% endif %}
            <button type="button" @click="toggleSection('hobby')" class="w-full text-left p-6 hover:bg-gradient-to-r hover:from-indigo-50/50 hover:to-purple-50/50 transition-all duration-200">
                 <div class="flex justify-between items-center">
                     <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-x-3">
                         <div class="p-2.5 bg-gradient-to-br {% if hobby_formset.non_form_errors or hobby_formset.errors|HasErrors %}from-red-500 to-red-600{% else %}from-pink-500 to-pink-600{% endif %} rounded-xl shadow-lg">
                             <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                             </svg>
                         </div>
                         <span>Hobbies</span>
                         {% if hobby_formset.non_form_errors or hobby_formset.errors|HasErrors %}
                             <span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full shadow-lg">Errors</span>
                         {% endif %}
                     </h2>
                     <svg class="w-6 h-6 transform transition-transform text-gray-400" :class="{'rotate-180': openSection === 'hobby'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                 </div>
            </button>
            <div x-show="openSection === 'hobby'" x-cloak x-transition class="p-6 border-t" id="formset-hobby">
                {{ hobby_formset.management_form }}
                {% if hobby_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ hobby_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-hobby">
                    {% for form in hobby_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-hobby">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'hobby')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div><button type="button" @click="addForm('hobby')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Hobby</button>
            </div>
        </div>
        
        <!-- Skills -->
        <div class="bg-white rounded-2xl shadow-xl transition-all duration-300 border-2 {% if skill_formset.non_form_errors or skill_formset.errors|HasErrors %}border-red-400 bg-gradient-to-br from-red-50/30 to-white{% else %}border-gray-200{% endif %} hover:shadow-2xl mb-6 overflow-hidden">
            {% if skill_formset.non_form_errors or skill_formset.errors|HasErrors %}
            <div class="h-1.5 bg-gradient-to-r from-red-500 via-red-600 to-red-500 animate-pulse"></div>
            {% endif %}
             <button type="button" @click="toggleSection('skill')" class="w-full text-left p-6 hover:bg-gradient-to-r hover:from-indigo-50/50 hover:to-purple-50/50 transition-all duration-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-x-3">
                        <div class="p-2.5 bg-gradient-to-br {% if skill_formset.non_form_errors or skill_formset.errors|HasErrors %}from-red-500 to-red-600{% else %}from-amber-500 to-amber-600{% endif %} rounded-xl shadow-lg">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                        </div>
                        <span>Skills</span>
                        {% if skill_formset.non_form_errors or skill_formset.errors|HasErrors %}
                            <span class="px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full shadow-lg animate-pulse">Errors</span>
                        {% endif %}
                    </h2>
                    <svg class="w-6 h-6 transform transition-transform text-gray-400" :class="{'rotate-180': openSection === 'skill'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
            </button>
            <div x-show="openSection === 'skill'" x-cloak x-transition class="p-6 border-t" id="formset-skill">
                {{ skill_formset.management_form }}
                 {% if skill_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ skill_formset.non_form_errors }}</div>{% endif %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="forms-container-skill">
                {% for form in skill_formset %}
                <div class="bg-gray-50 p-4 rounded-lg border relative form-row-skill">
                         <div class="absolute top-1 right-1">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'skill')" class="text-gray-400 hover:text-red-600 font-bold text-lg px-2">&times;</button></div>
                        {% for field in form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                </div>
                {% endfor %}
                </div>
                <button type="button" @click="addForm('skill')" class="mt-4 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Skill</button>
            </div>
        </div>
        
        <div class="pt-5">
            <button type="submit" form="validate-resume-form" onclick="handleFormSubmit(event)" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-green-600 via-emerald-600 to-teal-600 text-white font-bold py-4 px-6 rounded-xl hover:from-green-700 hover:via-emerald-700 hover:to-teal-700 transition-all duration-300 text-lg shadow-xl hover:shadow-2xl transform hover:-translate-y-0.5">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Confirm & Build My Resume
            </button>
        </div>
    </form>
</div>

<!-- Empty Form Templates -->
<template id="empty-form-template-experience"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-experience"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'experience')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in experience_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in experience_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>
<template id="empty-form-template-education"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-education"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'education')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in education_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in education_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>
<template id="empty-form-template-project"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-project"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'project')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in project_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in project_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>
<template id="empty-form-template-certification"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-certification"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'certification')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in certification_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in certification_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>
<template id="empty-form-template-achievement"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-achievement"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'achievement')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in achievement_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in achievement_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>
<template id="empty-form-template-language"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-language"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'language')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in language_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in language_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>
<template id="empty-form-template-hobby"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-hobby"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'hobby')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in hobby_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in hobby_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>

<template id="empty-form-template-skill">
    <div class="bg-gray-50 p-4 rounded-lg border relative form-row-skill">
        <div class="absolute top-1 right-1"><button type="button" @click="removeForm($event, 'skill')" class="text-gray-400 hover:text-red-600 font-bold text-lg px-2">&times;</button></div>
        {% for field in skill_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}
        {% for field in skill_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}
    </div>
</template>

<script>
    function formsetManager() {
        return {
            openSection: '{{ first_error_section|default:"personal" }}',
            init() {
                // Auto-open section with errors on page load
                {% if profile_form.errors %}
                    this.openSection = 'personal';
                {% endif %}
                
                // Scroll to first error field on page load
                this.$nextTick(() => {
                    const firstErrorField = document.querySelector('.is-invalid input, .is-invalid textarea, .is-invalid select, input:invalid, textarea:invalid, select:invalid');
                    if (firstErrorField) {
                        firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstErrorField.focus();
                    }
                });
            },
            toggleSection(section) {
                this.openSection = (this.openSection === section) ? null : section;
            },
            scrollToSection(section) {
                // Expand the section if it's closed
                if (this.openSection !== section) {
                    this.openSection = section;
                    // Wait for Alpine to render
                    this.$nextTick(() => {
                        const element = document.getElementById(`formset-${section}`);
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });
                } else {
                    const element = document.getElementById(`formset-${section}`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            },
            addForm(prefix) {
                const totalFormsInput = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
                if (!totalFormsInput) { console.error(`TOTAL_FORMS input for prefix ${prefix} not found.`); return; }
                const formIdx = parseInt(totalFormsInput.value);
                
                const template = document.getElementById(`empty-form-template-${prefix}`);
                if (!template) { console.error(`Template for prefix ${prefix} not found.`); return; }
                
                let newFormHtml = template.innerHTML.replace(/__prefix__/g, formIdx);
                
                const container = document.getElementById(`forms-container-${prefix}`);
                if (!container) { console.error(`Container for prefix ${prefix} not found.`); return; }

                container.insertAdjacentHTML('beforeend', newFormHtml);
                totalFormsInput.value = formIdx + 1;
            },
            removeForm(event, prefix) {
                const formRow = event.target.closest(`.form-row-${prefix}`);
                const deleteCheckbox = formRow.querySelector('.delete-checkbox');
                
                if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                    formRow.style.display = 'none';
                } else {
                    formRow.remove();
                }
            }
        }
    }

    // Scroll to specific field
    function scrollToField(fieldName) {
        const field = document.querySelector(`[name*="${fieldName}"]`);
        if (field) {
            const section = field.closest('[id^="formset-"]');
            if (section) {
                const sectionId = section.id.replace('formset-', '');
                const manager = Alpine.$data(document.querySelector('[x-data="formsetManager()"]'));
                if (manager) {
                    manager.openSection = sectionId;
                    manager.$nextTick(() => {
                        setTimeout(() => {
                            field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            field.focus();
                        }, 300);
                    });
                }
            }
        }
    }

    // Handle form submission and show validation errors
    function handleFormSubmit(event) {
        const form = document.getElementById('validate-resume-form');
        event.preventDefault();
        
        // Collect all errors from the form
        const errors = [];
        const errorFields = [];
        
        // Check for Django form errors (server-side validation) - look for error text elements
        const errorTextElements = form.querySelectorAll('.text-red-600, .text-red-700, [class*="error"]');
        errorTextElements.forEach(errorEl => {
            const errorText = errorEl.textContent.trim();
            if (errorText && errorText.length > 0 && !errors.includes(errorText)) {
                // Skip if it's just an icon or empty
                if (!errorText.match(/^[\s\S]*<svg[\s\S]*$/)) {
                    errors.push(errorText);
                }
            }
            // Find the associated input field
            const input = errorEl.closest('.mb-4')?.querySelector('input, textarea, select') || 
                         errorEl.previousElementSibling || 
                         errorEl.parentElement?.querySelector('input, textarea, select') ||
                         form.querySelector(`input[name="${errorEl.closest('[class*="field"]')?.querySelector('input, textarea, select')?.name}"]`);
            if (input && !errorFields.includes(input)) {
                errorFields.push(input);
            }
        });
        
        // Also check for fields with error classes
        const invalidInputs = form.querySelectorAll('input.is-invalid, textarea.is-invalid, select.is-invalid, .border-red-500');
        invalidInputs.forEach(input => {
            if (!errorFields.includes(input)) {
                errorFields.push(input);
            }
        });
        
        // Check for HTML5 validation errors (if any fields have required or pattern attributes)
        const requiredFields = form.querySelectorAll('input[required], textarea[required], select[required]');
        requiredFields.forEach(field => {
            if (!field.value || field.value.trim() === '') {
                const label = form.querySelector(`label[for="${field.id}"]`)?.textContent?.replace('*', '').trim() || field.name;
                const errorMsg = `${label} is required.`;
                if (!errors.includes(errorMsg)) {
                    errors.push(errorMsg);
                }
                if (!errorFields.includes(field)) {
                    errorFields.push(field);
                }
            }
        });
        
        // If there are errors, display them and scroll to first one
        if (errors.length > 0 || errorFields.length > 0) {
            // Scroll error summary into view if it exists
            const errorSummary = document.getElementById('error-summary');
            if (errorSummary) {
                errorSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Show detailed error message using toast
            if (window.toast && errors.length > 0) {
                const errorMessage = `Please fix ${errors.length} error${errors.length > 1 ? 's' : ''}. See the error summary above for details.`;
                window.toast.error(errorMessage, 8000);
            } else if (window.toast) {
                window.toast.error('Please fix the errors highlighted in red before submitting.', 8000);
            }
            
            // Open sections with errors and scroll to first error field
            if (errorFields.length > 0) {
                const firstErrorField = errorFields[0];
                let section = firstErrorField.closest('[id^="formset-"]');
                
                if (!section) {
                    // Try to find parent section
                    section = firstErrorField.closest('[x-show]')?.parentElement ||
                             firstErrorField.closest('.bg-white');
                }
                
                if (section && section.id) {
                    const sectionId = section.id.replace('formset-', '');
                    const manager = Alpine.$data(document.querySelector('[x-data="formsetManager()"]'));
                    if (manager) {
                        manager.openSection = sectionId;
                        manager.$nextTick(() => {
                            setTimeout(() => {
                                firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                firstErrorField.focus();
                            }, 300);
                        });
                    }
                } else {
                    // Fallback: just scroll to the field
                    setTimeout(() => {
                        firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstErrorField.focus();
                    }, 100);
                }
            }
            
            return false;
        }
        
        // If no errors, submit the form
        form.submit();
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.body.addEventListener('click', function(event) {
            if (event.target.classList.contains('enhance-btn')) {
                const button = event.target;
                const targetId = button.dataset.enhanceTarget;
                const context = button.dataset.enhanceContext;
                
                const textInput = document.getElementById(targetId);

                if (!textInput || !textInput.value) {
                    if (window.toast) {
                        window.toast.warning('Please enter some text to enhance.');
                    } else {
                        alert('Please enter some text to enhance.');
                    }
                    return;
                }

                const originalButtonText = button.innerHTML;
                button.innerHTML = 'Enhancing...';
                button.disabled = true;

                fetch("{% url 'resumes:enhance-api' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ text: textInput.value, context: context })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if (data.enhanced_text) {
                        textInput.value = data.enhanced_text;
                    } else {
                        const errorMsg = data.error || 'Sorry, we encountered an error.';
                        if (window.toast) {
                            window.toast.error(errorMsg);
                        } else {
                            alert(errorMsg);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const errorMsg = 'An error occurred. Please check the console for details.';
                    if (window.toast) {
                        window.toast.error(errorMsg);
                    } else {
                        alert(errorMsg);
                    }
                })
                .finally(() => {
                    button.innerHTML = originalButtonText;
                    button.disabled = false;
                });
            }
        });
    });
</script>
{% endblock %}

