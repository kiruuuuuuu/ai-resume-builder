{% extends 'base.html' %}
{% load crispy_forms_tags custom_filters %}

{% block title %}Confirm Your Details{% endblock %}

{% block content %}
<!-- Enhanced Hero Section -->
<div class="relative bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 overflow-hidden">
    <div class="absolute inset-0 bg-black opacity-10"></div>
    <div class="absolute inset-0" style="background-image: url('data:image/svg+xml,%3Csvg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"%3E%3Cg fill=\"none\" fill-rule=\"evenodd\"%3E%3Cg fill=\"%23ffffff\" fill-opacity=\"0.05\"%3E%3Cpath d=\"M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
    <div class="relative max-w-7xl mx-auto px-4 py-16 text-center">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-white/20 backdrop-blur-sm rounded-2xl mb-6">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <h1 class="text-5xl md:text-6xl font-bold text-white mb-4 animate-fade-in-up drop-shadow-lg">
            Confirm Your Details
        </h1>
        <p class="text-xl text-indigo-100 mb-8 animate-fade-in-up delay-100">
            Our AI has extracted the following information. Please review, correct, and add any missing details before saving.
        </p>
    </div>
</div>

<div class="max-w-4xl mx-auto py-12 px-4 -mt-8" x-data="formsetManager()">

    <!-- Enhanced Sticky Navigation Bar -->
    <nav class="sticky top-16 z-30 bg-white/95 backdrop-blur-lg shadow-xl rounded-xl mb-8 px-4 py-4 border border-gray-200/60" style="scroll-margin-top: 1rem;">
        <div class="flex flex-wrap justify-center gap-2 md:gap-4 text-sm">
            <a href="#formset-personal" @click.prevent="scrollToSection('personal')" class="px-4 py-2 rounded-lg text-gray-700 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 hover:text-indigo-700 transition-all duration-200 font-medium {% if profile_form.errors %}font-semibold text-red-600 bg-red-50 border border-red-200{% endif %}">Personal</a>
            <a href="#formset-experience" @click.prevent="scrollToSection('experience')" class="px-3 py-2 rounded-md text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-colors {% if experience_formset.errors or experience_formset.non_form_errors %}font-semibold text-red-600{% endif %}">Experience</a>
            <a href="#formset-education" @click.prevent="scrollToSection('education')" class="px-3 py-2 rounded-md text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-colors {% if education_formset.errors or education_formset.non_form_errors %}font-semibold text-red-600{% endif %}">Education</a>
            <a href="#formset-skill" @click.prevent="scrollToSection('skill')" class="px-3 py-2 rounded-md text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-colors {% if skill_formset.errors or skill_formset.non_form_errors %}font-semibold text-red-600{% endif %}">Skills</a>
            <a href="#formset-project" @click.prevent="scrollToSection('project')" class="px-3 py-2 rounded-md text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-colors {% if project_formset.errors or project_formset.non_form_errors %}font-semibold text-red-600{% endif %}">Projects</a>
            <a href="#formset-certification" @click.prevent="scrollToSection('certification')" class="px-3 py-2 rounded-md text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-colors {% if certification_formset.errors or certification_formset.non_form_errors %}font-semibold text-red-600{% endif %}">Certifications</a>
            <a href="#formset-achievement" @click.prevent="scrollToSection('achievement')" class="px-3 py-2 rounded-md text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-colors {% if achievement_formset.errors or achievement_formset.non_form_errors %}font-semibold text-red-600{% endif %}">Achievements</a>
            <a href="#formset-language" @click.prevent="scrollToSection('language')" class="px-3 py-2 rounded-md text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-colors {% if language_formset.errors or language_formset.non_form_errors %}font-semibold text-red-600{% endif %}">Languages</a>
            <a href="#formset-hobby" @click.prevent="scrollToSection('hobby')" class="px-3 py-2 rounded-md text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition-colors {% if hobby_formset.errors or hobby_formset.non_form_errors %}font-semibold text-red-600{% endif %}">Hobbies</a>
        </div>
    </nav>

    <!-- Error Summary (shown when form has errors) -->
    {% if profile_form.errors or experience_formset.errors or education_formset.errors or skill_formset.errors or project_formset.errors or certification_formset.errors or achievement_formset.errors or language_formset.errors or hobby_formset.errors %}
    <div id="error-summary" class="mb-6 p-6 bg-red-50 border-2 border-red-200 rounded-xl shadow-lg">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-6 w-6 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3 flex-1">
                <h3 class="text-lg font-semibold text-red-800 mb-2">Please fix the following errors:</h3>
                <ul class="list-disc list-inside space-y-1 text-sm text-red-700">
                    {% if profile_form.errors %}
                        {% for field, errors in profile_form.errors.items %}
                            {% for error in errors %}
                                <li><strong>{{ field|title }}:</strong> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                    {% endif %}
                    {% if experience_formset.errors %}
                        {% for form in experience_formset %}
                            {% if form.errors %}
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li><strong>Experience {{ forloop.parentloop.counter }} - {{ field|title }}:</strong> {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if education_formset.errors %}
                        {% for form in education_formset %}
                            {% if form.errors %}
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li><strong>Education {{ forloop.parentloop.counter }} - {{ field|title }}:</strong> {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if skill_formset.errors %}
                        {% for form in skill_formset %}
                            {% if form.errors %}
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li><strong>Skill {{ forloop.parentloop.counter }} - {{ field|title }}:</strong> {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if project_formset.errors %}
                        {% for form in project_formset %}
                            {% if form.errors %}
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li><strong>Project {{ forloop.parentloop.counter }} - {{ field|title }}:</strong> {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if certification_formset.errors %}
                        {% for form in certification_formset %}
                            {% if form.errors %}
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li><strong>Certification {{ forloop.parentloop.counter }} - {{ field|title }}:</strong> {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if achievement_formset.errors %}
                        {% for form in achievement_formset %}
                            {% if form.errors %}
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li><strong>Achievement {{ forloop.parentloop.counter }} - {{ field|title }}:</strong> {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if language_formset.errors %}
                        {% for form in language_formset %}
                            {% if form.errors %}
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li><strong>Language {{ forloop.parentloop.counter }} - {{ field|title }}:</strong> {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if hobby_formset.errors %}
                        {% for form in hobby_formset %}
                            {% if form.errors %}
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li><strong>Hobby {{ forloop.parentloop.counter }} - {{ field|title }}:</strong> {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    {% endif %}

    <form id="validate-resume-form" method="POST" enctype="multipart/form-data" class="space-y-4" novalidate>
        {% csrf_token %}

        <!-- Personal Information -->
        <div class="bg-white/95 backdrop-blur-sm rounded-xl shadow-xl transition-all duration-300 border-2 border-gray-200/60 hover:shadow-2xl hover:border-indigo-300 mb-6">
            <button type="button" @click="toggleSection('personal')" class="w-full text-left p-6 hover:bg-gradient-to-r hover:from-indigo-50/50 hover:to-purple-50/50 transition-all duration-200 rounded-t-xl">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-x-3">
                        <div class="p-2 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                        </div>
                        Personal Details {% if profile_form.errors %}<span class="h-3 w-3 rounded-full bg-red-500 animate-pulse shadow-lg"></span>{% endif %}
                    </h2>
                    <svg class="w-6 h-6 transform transition-transform text-gray-400" :class="{'rotate-180': openSection === 'personal'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
            </button>
            <div x-show="openSection === 'personal'" x-cloak x-transition class="p-6 border-t border-gray-200" id="formset-personal">
                {% if profile_form.non_field_errors %}
                    <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">Form Errors</h3>
                                <div class="mt-2 text-sm text-red-700">
                                    <ul class="list-disc list-inside">
                                        {% for error in profile_form.non_field_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
                {% for field in profile_form.visible_fields %}
                    <div class="mb-4">
                        {{ field|as_crispy_field }}
                        {% if field.errors %}
                            <div class="mt-1 text-sm text-red-600">
                                {% for error in field.errors %}
                                    <p class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                        {{ error }}
                                    </p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    {% if field.name == 'professional_summary' %}
                        <div class="flex justify-end -mt-2 mb-4">
                            <button type="button" class="enhance-btn text-sm font-medium text-purple-600 hover:text-purple-800" 
                                    data-enhance-target="{{ field.id_for_label }}" 
                                    data-enhance-context="professional_summary">✨ Enhance with AI</button>
                        </div>
                    {% endif %}
                {% endfor %}
                {% for field in profile_form.hidden_fields %}{{ field }}{% endfor %}
            </div>
        </div>

        <!-- Experience -->
        <div class="bg-white rounded-xl shadow-lg transition-all duration-300 border">
            <button type="button" @click="toggleSection('experience')" class="w-full text-left p-6">
                <div class="flex justify-between items-center">
                     <h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-x-2">
                        Experience {% if experience_formset.non_form_errors or experience_formset.errors|HasErrors %}<span class="h-3 w-3 rounded-full bg-red-500"></span>{% endif %}
                    </h2>
                    <svg class="w-6 h-6 transform transition-transform" :class="{'rotate-180': openSection === 'experience'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
            </button>
            <div x-show="openSection === 'experience'" x-cloak x-transition class="p-6 border-t" id="formset-experience">
                {{ experience_formset.management_form }}
                {% if experience_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ experience_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-experience">
                    {% for form in experience_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-experience">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'experience')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}
                            {{ field|as_crispy_field }}
                            {% if field.name == 'description' %}
                                <div class="flex justify-end -mt-2 mb-4">
                                    <button type="button" class="enhance-btn text-sm font-medium text-purple-600 hover:text-purple-800"
                                            data-enhance-target="{{ field.id_for_label }}"
                                            data-enhance-context="experience_description">✨ Enhance with AI</button>
                                </div>
                            {% endif %}
                        {% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div>
                <button type="button" @click="addForm('experience')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Experience</button>
            </div>
        </div>

        <!-- Education -->
        <div class="bg-white rounded-xl shadow-lg transition-all duration-300 border">
            <button type="button" @click="toggleSection('education')" class="w-full text-left p-6">
                 <div class="flex justify-between items-center"><h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-x-2">Education {% if education_formset.non_form_errors or education_formset.errors|HasErrors %}<span class="h-3 w-3 rounded-full bg-red-500"></span>{% endif %}</h2><svg class="w-6 h-6 transform transition-transform" :class="{'rotate-180': openSection === 'education'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></div>
            </button>
            <div x-show="openSection === 'education'" x-cloak x-transition class="p-6 border-t" id="formset-education">
                {{ education_formset.management_form }}
                {% if education_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ education_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-education">
                    {% for form in education_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-education">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'education')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div><button type="button" @click="addForm('education')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Education</button>
            </div>
        </div>

        <!-- Projects -->
         <div class="bg-white rounded-xl shadow-lg transition-all duration-300 border">
            <button type="button" @click="toggleSection('project')" class="w-full text-left p-6">
                 <div class="flex justify-between items-center"><h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-x-2">Projects {% if project_formset.non_form_errors or project_formset.errors|HasErrors %}<span class="h-3 w-3 rounded-full bg-red-500"></span>{% endif %}</h2><svg class="w-6 h-6 transform transition-transform" :class="{'rotate-180': openSection === 'project'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></div>
            </button>
            <div x-show="openSection === 'project'" x-cloak x-transition class="p-6 border-t" id="formset-project">
                {{ project_formset.management_form }}
                {% if project_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ project_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-project">
                    {% for form in project_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-project">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'project')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}
                            {{ field|as_crispy_field }}
                            {% if field.name == 'description' %}
                                <div class="flex justify-end -mt-2 mb-4">
                                    <button type="button" class="enhance-btn text-sm font-medium text-purple-600 hover:text-purple-800"
                                            data-enhance-target="{{ field.id_for_label }}"
                                            data-enhance-context="experience_description">✨ Enhance with AI</button>
                                </div>
                            {% endif %}
                        {% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div><button type="button" @click="addForm('project')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Project</button>
            </div>
        </div>

        <!-- Certifications -->
        <div class="bg-white rounded-xl shadow-lg transition-all duration-300 border">
            <button type="button" @click="toggleSection('certification')" class="w-full text-left p-6">
                 <div class="flex justify-between items-center"><h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-x-2">Certifications {% if certification_formset.non_form_errors or certification_formset.errors|HasErrors %}<span class="h-3 w-3 rounded-full bg-red-500"></span>{% endif %}</h2><svg class="w-6 h-6 transform transition-transform" :class="{'rotate-180': openSection === 'certification'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></div>
            </button>
            <div x-show="openSection === 'certification'" x-cloak x-transition class="p-6 border-t" id="formset-certification">
                {{ certification_formset.management_form }}
                {% if certification_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ certification_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-certification">
                    {% for form in certification_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-certification">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'certification')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div><button type="button" @click="addForm('certification')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Certification</button>
            </div>
        </div>

        <!-- Achievements -->
        <div class="bg-white rounded-xl shadow-lg transition-all duration-300 border">
            <button type="button" @click="toggleSection('achievement')" class="w-full text-left p-6">
                 <div class="flex justify-between items-center"><h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-x-2">Achievements {% if achievement_formset.non_form_errors or achievement_formset.errors|HasErrors %}<span class="h-3 w-3 rounded-full bg-red-500"></span>{% endif %}</h2><svg class="w-6 h-6 transform transition-transform" :class="{'rotate-180': openSection === 'achievement'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></div>
            </button>
            <div x-show="openSection === 'achievement'" x-cloak x-transition class="p-6 border-t" id="formset-achievement">
                {{ achievement_formset.management_form }}
                {% if achievement_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ achievement_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-achievement">
                    {% for form in achievement_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-achievement">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'achievement')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}
                            {{ field|as_crispy_field }}
                            {% if field.name == 'description' %}
                                <div class="flex justify-end -mt-2 mb-4">
                                    <button type="button" class="enhance-btn text-sm font-medium text-purple-600 hover:text-purple-800"
                                            data-enhance-target="{{ field.id_for_label }}"
                                            data-enhance-context="experience_description">✨ Enhance with AI</button>
                                </div>
                            {% endif %}
                        {% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div><button type="button" @click="addForm('achievement')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Achievement</button>
            </div>
        </div>

        <!-- Languages -->
        <div class="bg-white rounded-xl shadow-lg transition-all duration-300 border">
            <button type="button" @click="toggleSection('language')" class="w-full text-left p-6">
                 <div class="flex justify-between items-center"><h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-x-2">Languages {% if language_formset.non_form_errors or language_formset.errors|HasErrors %}<span class="h-3 w-3 rounded-full bg-red-500"></span>{% endif %}</h2><svg class="w-6 h-6 transform transition-transform" :class="{'rotate-180': openSection === 'language'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></div>
            </button>
            <div x-show="openSection === 'language'" x-cloak x-transition class="p-6 border-t" id="formset-language">
                {{ language_formset.management_form }}
                {% if language_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ language_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-language">
                    {% for form in language_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-language">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'language')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div><button type="button" @click="addForm('language')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Language</button>
            </div>
        </div>

        <!-- Hobbies -->
        <div class="bg-white rounded-xl shadow-lg transition-all duration-300 border">
            <button type="button" @click="toggleSection('hobby')" class="w-full text-left p-6">
                 <div class="flex justify-between items-center"><h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-x-2">Hobbies {% if hobby_formset.non_form_errors or hobby_formset.errors|HasErrors %}<span class="h-3 w-3 rounded-full bg-red-500"></span>{% endif %}</h2><svg class="w-6 h-6 transform transition-transform" :class="{'rotate-180': openSection === 'hobby'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></div>
            </button>
            <div x-show="openSection === 'hobby'" x-cloak x-transition class="p-6 border-t" id="formset-hobby">
                {{ hobby_formset.management_form }}
                {% if hobby_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ hobby_formset.non_form_errors }}</div>{% endif %}
                <div id="forms-container-hobby">
                    {% for form in hobby_formset %}
                    <div class="space-y-4 border-b pb-6 mb-6 relative form-row-hobby">
                        <div class="absolute top-0 right-0">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'hobby')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>
                        {% for field in form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                    </div>
                    {% endfor %}
                </div><button type="button" @click="addForm('hobby')" class="mt-2 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Hobby</button>
            </div>
        </div>
        
        <!-- Skills -->
        <div class="bg-white rounded-xl shadow-lg transition-all duration-300 border">
             <button type="button" @click="toggleSection('skill')" class="w-full text-left p-6">
                <div class="flex justify-between items-center"><h2 class="text-2xl font-semibold text-gray-900 flex items-center gap-x-2">Skills {% if skill_formset.non_form_errors or skill_formset.errors|HasErrors %}<span class="h-3 w-3 rounded-full bg-red-500"></span>{% endif %}</h2><svg class="w-6 h-6 transform transition-transform" :class="{'rotate-180': openSection === 'skill'}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg></div>
            </button>
            <div x-show="openSection === 'skill'" x-cloak x-transition class="p-6 border-t" id="formset-skill">
                {{ skill_formset.management_form }}
                 {% if skill_formset.non_form_errors %}<div class="text-red-600 text-sm mb-4 p-3 bg-red-50 rounded-md border border-red-200">{{ skill_formset.non_form_errors }}</div>{% endif %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="forms-container-skill">
                {% for form in skill_formset %}
                <div class="bg-gray-50 p-4 rounded-lg border relative form-row-skill">
                         <div class="absolute top-1 right-1">{% if form.instance.pk %}<input type="checkbox" name="{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" id="id_{{ form.prefix }}-{{ forloop.counter0 }}-DELETE" class="hidden delete-checkbox">{% endif %}<button type="button" @click="removeForm($event, 'skill')" class="text-gray-400 hover:text-red-600 font-bold text-lg px-2">&times;</button></div>
                        {% for field in form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}
                        {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                </div>
                {% endfor %}
                </div>
                <button type="button" @click="addForm('skill')" class="mt-4 text-sm font-medium text-indigo-600 hover:text-indigo-500">+ Add Another Skill</button>
            </div>
        </div>
        
        <div class="pt-5">
            <button type="submit" form="validate-resume-form" onclick="handleFormSubmit(event)" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-green-600 via-emerald-600 to-teal-600 text-white font-bold py-4 px-6 rounded-xl hover:from-green-700 hover:via-emerald-700 hover:to-teal-700 transition-all duration-300 text-lg shadow-xl hover:shadow-2xl transform hover:-translate-y-0.5">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Confirm & Build My Resume
            </button>
        </div>
    </form>
</div>

<!-- Empty Form Templates -->
<template id="empty-form-template-experience"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-experience"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'experience')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in experience_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in experience_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>
<template id="empty-form-template-education"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-education"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'education')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in education_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in education_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>
<template id="empty-form-template-project"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-project"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'project')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in project_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in project_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>
<template id="empty-form-template-certification"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-certification"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'certification')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in certification_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in certification_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>
<template id="empty-form-template-achievement"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-achievement"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'achievement')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in achievement_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in achievement_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>
<template id="empty-form-template-language"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-language"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'language')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in language_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in language_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>
<template id="empty-form-template-hobby"><div class="space-y-4 border-b pb-6 mb-6 relative form-row-hobby"><div class="absolute top-0 right-0"><button type="button" @click="removeForm($event, 'hobby')" class="text-gray-400 hover:text-red-600 font-bold text-xl px-2">&times;</button></div>{% for field in hobby_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}{% for field in hobby_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}</div></template>

<template id="empty-form-template-skill">
    <div class="bg-gray-50 p-4 rounded-lg border relative form-row-skill">
        <div class="absolute top-1 right-1"><button type="button" @click="removeForm($event, 'skill')" class="text-gray-400 hover:text-red-600 font-bold text-lg px-2">&times;</button></div>
        {% for field in skill_formset.empty_form.visible_fields %}{{ field|as_crispy_field }}{% endfor %}
        {% for field in skill_formset.empty_form.hidden_fields %}{{ field }}{% endfor %}
    </div>
</template>

<script>
    function formsetManager() {
        return {
            openSection: '{{ first_error_section|default:"personal" }}',
            init() {
                // Auto-open section with errors on page load
                {% if profile_form.errors %}
                    this.openSection = 'personal';
                {% endif %}
                
                // Scroll to first error field on page load
                this.$nextTick(() => {
                    const firstErrorField = document.querySelector('.is-invalid input, .is-invalid textarea, .is-invalid select, input:invalid, textarea:invalid, select:invalid');
                    if (firstErrorField) {
                        firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstErrorField.focus();
                    }
                });
            },
            toggleSection(section) {
                this.openSection = (this.openSection === section) ? null : section;
            },
            scrollToSection(section) {
                // Expand the section if it's closed
                if (this.openSection !== section) {
                    this.openSection = section;
                    // Wait for Alpine to render
                    this.$nextTick(() => {
                        const element = document.getElementById(`formset-${section}`);
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });
                } else {
                    const element = document.getElementById(`formset-${section}`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            },
            addForm(prefix) {
                const totalFormsInput = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
                if (!totalFormsInput) { console.error(`TOTAL_FORMS input for prefix ${prefix} not found.`); return; }
                const formIdx = parseInt(totalFormsInput.value);
                
                const template = document.getElementById(`empty-form-template-${prefix}`);
                if (!template) { console.error(`Template for prefix ${prefix} not found.`); return; }
                
                let newFormHtml = template.innerHTML.replace(/__prefix__/g, formIdx);
                
                const container = document.getElementById(`forms-container-${prefix}`);
                if (!container) { console.error(`Container for prefix ${prefix} not found.`); return; }

                container.insertAdjacentHTML('beforeend', newFormHtml);
                totalFormsInput.value = formIdx + 1;
            },
            removeForm(event, prefix) {
                const formRow = event.target.closest(`.form-row-${prefix}`);
                const deleteCheckbox = formRow.querySelector('.delete-checkbox');
                
                if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                    formRow.style.display = 'none';
                } else {
                    formRow.remove();
                }
            }
        }
    }

    // Handle form submission and show validation errors
    function handleFormSubmit(event) {
        const form = document.getElementById('validate-resume-form');
        event.preventDefault();
        
        // Collect all errors from the form
        const errors = [];
        const errorFields = [];
        
        // Check for Django form errors (server-side validation) - look for error text elements
        const errorTextElements = form.querySelectorAll('.text-red-600, .text-red-700, [class*="error"]');
        errorTextElements.forEach(errorEl => {
            const errorText = errorEl.textContent.trim();
            if (errorText && errorText.length > 0 && !errors.includes(errorText)) {
                // Skip if it's just an icon or empty
                if (!errorText.match(/^[\s\S]*<svg[\s\S]*$/)) {
                    errors.push(errorText);
                }
            }
            // Find the associated input field
            const input = errorEl.closest('.mb-4')?.querySelector('input, textarea, select') || 
                         errorEl.previousElementSibling || 
                         errorEl.parentElement?.querySelector('input, textarea, select') ||
                         form.querySelector(`input[name="${errorEl.closest('[class*="field"]')?.querySelector('input, textarea, select')?.name}"]`);
            if (input && !errorFields.includes(input)) {
                errorFields.push(input);
            }
        });
        
        // Also check for fields with error classes
        const invalidInputs = form.querySelectorAll('input.is-invalid, textarea.is-invalid, select.is-invalid, .border-red-500');
        invalidInputs.forEach(input => {
            if (!errorFields.includes(input)) {
                errorFields.push(input);
            }
        });
        
        // Check for HTML5 validation errors (if any fields have required or pattern attributes)
        const requiredFields = form.querySelectorAll('input[required], textarea[required], select[required]');
        requiredFields.forEach(field => {
            if (!field.value || field.value.trim() === '') {
                const label = form.querySelector(`label[for="${field.id}"]`)?.textContent?.replace('*', '').trim() || field.name;
                const errorMsg = `${label} is required.`;
                if (!errors.includes(errorMsg)) {
                    errors.push(errorMsg);
                }
                if (!errorFields.includes(field)) {
                    errorFields.push(field);
                }
            }
        });
        
        // If there are errors, display them and scroll to first one
        if (errors.length > 0 || errorFields.length > 0) {
            // Scroll error summary into view if it exists
            const errorSummary = document.getElementById('error-summary');
            if (errorSummary) {
                errorSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Show detailed error message using toast
            if (window.toast && errors.length > 0) {
                const errorMessage = `Please fix ${errors.length} error${errors.length > 1 ? 's' : ''}. See the error summary above for details.`;
                window.toast.error(errorMessage, 8000);
            } else if (window.toast) {
                window.toast.error('Please fix the errors highlighted in red before submitting.', 8000);
            }
            
            // Open sections with errors and scroll to first error field
            if (errorFields.length > 0) {
                const firstErrorField = errorFields[0];
                let section = firstErrorField.closest('[id^="formset-"]');
                
                if (!section) {
                    // Try to find parent section
                    section = firstErrorField.closest('[x-show]')?.parentElement ||
                             firstErrorField.closest('.bg-white');
                }
                
                if (section && section.id) {
                    const sectionId = section.id.replace('formset-', '');
                    const manager = Alpine.$data(document.querySelector('[x-data="formsetManager()"]'));
                    if (manager) {
                        manager.openSection = sectionId;
                        manager.$nextTick(() => {
                            setTimeout(() => {
                                firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                firstErrorField.focus();
                            }, 300);
                        });
                    }
                } else {
                    // Fallback: just scroll to the field
                    setTimeout(() => {
                        firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstErrorField.focus();
                    }, 100);
                }
            }
            
            return false;
        }
        
        // If no errors, submit the form
        form.submit();
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.body.addEventListener('click', function(event) {
            if (event.target.classList.contains('enhance-btn')) {
                const button = event.target;
                const targetId = button.dataset.enhanceTarget;
                const context = button.dataset.enhanceContext;
                
                const textInput = document.getElementById(targetId);

                if (!textInput || !textInput.value) {
                    if (window.toast) {
                        window.toast.warning('Please enter some text to enhance.');
                    } else {
                        alert('Please enter some text to enhance.');
                    }
                    return;
                }

                const originalButtonText = button.innerHTML;
                button.innerHTML = 'Enhancing...';
                button.disabled = true;

                fetch("{% url 'resumes:enhance-api' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ text: textInput.value, context: context })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if (data.enhanced_text) {
                        textInput.value = data.enhanced_text;
                    } else {
                        const errorMsg = data.error || 'Sorry, we encountered an error.';
                        if (window.toast) {
                            window.toast.error(errorMsg);
                        } else {
                            alert(errorMsg);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    const errorMsg = 'An error occurred. Please check the console for details.';
                    if (window.toast) {
                        window.toast.error(errorMsg);
                    } else {
                        alert(errorMsg);
                    }
                })
                .finally(() => {
                    button.innerHTML = originalButtonText;
                    button.disabled = false;
                });
            }
        });
    });
</script>
{% endblock %}

