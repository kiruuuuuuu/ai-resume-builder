{% extends 'base.html' %}
{% load crispy_forms_tags resume_extras %}

{% block title %}AI Resume Builder{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced Performance Optimizations */
    
    /* Tab transitions with smooth animations */
    [x-show] {
        contain: layout style paint;
    }
    
    /* Smooth scrolling for preview */
    .scrollbar-thin {
        scrollbar-width: thin;
    }
    
    .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }
    
    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    /* Enhanced animations */
    .transition-all {
        transition-property: all;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Tab enhancements with sliding indicator */
    .tab-indicator {
        position: absolute;
        bottom: 0;
        height: 3px;
        background: linear-gradient(90deg, #6366f1, #8b5cf6);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 3px 3px 0 0;
    }
    
    /* Section completion indicator */
    .section-completion-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        font-size: 11px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .section-completion-badge.complete {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }
    
    .section-completion-badge.partial {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }
    
    .section-completion-badge.empty {
        background: #e5e7eb;
        color: #6b7280;
    }
    
    /* Floating label styles */
    .floating-label-group {
        position: relative;
        margin-bottom: 1.5rem;
    }
    
    .floating-label-group input,
    .floating-label-group textarea,
    .floating-label-group select {
        transition: all 0.2s ease;
    }
    
    .floating-label-group input:focus + label,
    .floating-label-group textarea:focus + label,
    .floating-label-group input:not(:placeholder-shown) + label,
    .floating-label-group textarea:not(:placeholder-shown) + label,
    .floating-label-group select:focus + label,
    .floating-label-group select:not([value=""]) + label {
        transform: translateY(-1.75rem) scale(0.85);
        color: #6366f1;
    }
    
    /* Auto-save indicator */
    .save-indicator {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 40;
        padding: 12px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateY(20px);
        pointer-events: none;
    }
    
    .save-indicator.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .save-indicator.saving {
        color: #6366f1;
    }
    
    .save-indicator.saved {
        color: #10b981;
    }
    
    /* Drag & Drop styles */
    .draggable-item {
        cursor: grab;
        transition: all 0.2s ease;
    }
    
    .draggable-item:active {
        cursor: grabbing;
    }
    
    .draggable-item.dragging {
        opacity: 0.5;
        transform: scale(0.98);
    }
    
    .drag-handle {
        cursor: grab;
        color: #9ca3af;
        transition: color 0.2s ease;
    }
    
    .drag-handle:hover {
        color: #6366f1;
    }
    
    .drag-over {
        border-top: 3px solid #6366f1;
        background: #eef2ff;
    }
    
    /* Enhanced tooltip */
    .tooltip-container {
        position: relative;
        display: inline-block;
    }
    
    .tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(-8px);
        background: #1f2937;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: all 0.2s ease;
        z-index: 50;
        margin-bottom: 8px;
    }
    
    .tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: #1f2937;
    }
    
    .tooltip-container:hover .tooltip {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    
    /* Mobile tab layout */
    @media (max-width: 1024px) {
        .tab-navigation {
            flex-direction: column;
            gap: 8px;
        }
        
        .tab-button {
            width: 100%;
            text-align: left;
            border-radius: 8px;
            padding: 12px 16px;
        }
    }
    
    /* Enhanced chart animations */
    @keyframes chartPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    #score-chart-container {
        animation: chartPulse 2s ease-in-out infinite;
    }
    
    /* Enhanced form input styles */
    .form-input-enhanced {
        transition: all 0.2s ease;
    }
    
    .form-input-enhanced:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    /* Loading skeleton */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s ease-in-out infinite;
    }
    
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    
    /* Enhanced card hover effects */
    .card-enhanced {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .card-enhanced:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8" x-data="resumeBuilder()">
    
    <header class="mb-8 relative">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div class="flex-1">
                <h1 id="resume-title" class="text-3xl font-bold tracking-tight text-gray-900 mb-2">{{ resume.title }}</h1>
                <p class="text-sm text-gray-500">Build and enhance your professional resume</p>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0">
                <a href="{% url 'resumes:preview-resume' resume_id=resume.id %}?template=professional&accent_color=indigo" 
                   target="_blank"
                   class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 transition-all duration-200 transform hover:scale-105">
                    <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    Preview & Download
                </a>
            </div>
        </div>
    </header>

    <!-- AI Score & Feedback - Enhanced -->
    <div class="bg-gradient-to-br from-white to-indigo-50/30 p-6 rounded-xl shadow-lg mb-10 border border-gray-200 card-enhanced" x-data="scoreChecker({{ resume.id }})" x-init="init()">
        <div class="flex items-center gap-3 mb-6">
            <div class="flex-shrink-0 relative">
                <div class="h-12 w-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                    <svg class="h-7 w-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                </div>
                <div class="absolute -top-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white animate-pulse"></div>
            </div>
            <div class="flex-1">
                <h2 class="text-2xl font-bold text-gray-900">AI Score & Feedback</h2>
                <p class="text-sm text-gray-500 mt-1">Get instant feedback on your resume quality</p>
            </div>
        </div>
        <div x-show="isLoading" x-cloak class="flex items-center gap-4 py-8">
            <div class="relative">
                <div class="spinner"></div>
            </div>
            <div class="flex-1">
                <p class="font-semibold text-gray-700">AI analysis in progress...</p>
                <p class="text-sm text-gray-500 mt-1">Your score and feedback will appear here shortly.</p>
                <div class="mt-3 w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                </div>
            </div>
        </div>
        <div x-show="!isLoading && score !== null && score !== undefined" x-cloak x-transition class="flex flex-col md:flex-row items-start gap-8">
            <div id="score-chart-container" class="flex-shrink-0 flex flex-col items-center justify-center bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 rounded-2xl p-8 border-2 border-indigo-200 shadow-sm">
                <canvas id="score-chart" width="180" height="180"></canvas>
                <p class="text-sm font-bold text-gray-700 mt-5 text-center uppercase tracking-wider" style="letter-spacing: 1.5px; font-family: 'Inter', sans-serif;">Your Score</p>
                <p class="text-xs text-gray-500 mt-1 text-center">Out of 100</p>
                <div class="mt-4 px-4 py-2 rounded-full" 
                     :class="score >= 80 ? 'bg-green-100 text-green-700' : score >= 60 ? 'bg-blue-100 text-blue-700' : score >= 40 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'">
                    <span class="text-sm font-bold" 
                          x-text="score >= 80 ? 'Excellent' : score >= 60 ? 'Good' : score >= 40 ? 'Fair' : 'Needs Work'"></span>
                </div>
            </div>
            <div class="flex-1">
                <h3 class="text-xl font-bold text-gray-900 mb-5 tracking-tight" style="font-family: 'Inter', sans-serif;">Actionable Suggestions</h3>
                <ul class="space-y-4">
                    <template x-for="(item, index) in feedback" :key="index">
                        <li class="flex items-start gap-4 p-4 bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow duration-200">
                            <div class="flex-shrink-0 mt-1">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-sm">
                                    <span class="text-white font-bold text-sm" x-text="index + 1"></span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p class="text-base text-gray-800 leading-relaxed" style="font-family: 'Inter', sans-serif; line-height: 1.6;" x-text="item"></p>
                            </div>
                        </li>
                    </template>
                    <template x-if="!feedback || feedback.length === 0">
                        <li class="text-sm text-gray-500 italic p-4 bg-gray-50 rounded-lg border border-gray-200">No feedback available at this time.</li>
                    </template>
                </ul>
            </div>
        </div>
    </div>

    <!-- Full Width Editor Layout -->
    <div class="w-full">
        <!-- Tabbed Interface Container -->
        <div class="w-full">
    <div x-data="tabNavigation({{ resume.id }})" x-init="init()">
        <div class="mb-8 border-b border-gray-200 bg-white sticky top-16 z-30 shadow-sm">
            <nav class="-mb-px flex space-x-1 overflow-x-auto scrollbar-hide tab-navigation relative" aria-label="Tabs" style="scrollbar-width: none; -ms-overflow-style: none;">
                <style>.scrollbar-hide::-webkit-scrollbar { display: none; }</style>
                <!-- Sliding indicator -->
                <div class="tab-indicator" :style="tabIndicatorStyle"></div>
                
                <button @click="switchTab('details')" 
                        :class="{ 'text-indigo-600 font-semibold': activeTab === 'details', 'text-gray-500 hover:text-gray-700': activeTab !== 'details' }" 
                        class="whitespace-nowrap py-4 px-5 font-medium text-sm transition-all duration-300 relative z-10 flex items-center gap-2 tab-button"
                        :aria-current="activeTab === 'details' ? 'page' : null">
                    <span class="section-completion-badge" 
                          :class="sectionCompletion.details === 100 ? 'complete' : sectionCompletion.details > 0 ? 'partial' : 'empty'"
                          x-text="sectionCompletion.details === 100 ? '✓' : sectionCompletion.details > 0 ? '~' : '○'"></span>
                    Personal Details
                </button>
                {% for section in resume_sections %}
                <button @click="switchTab('{{ section.name }}')" 
                        :class="{ 'text-indigo-600 font-semibold': activeTab === '{{ section.name }}', 'text-gray-500 hover:text-gray-700': activeTab !== '{{ section.name }}' }" 
                        class="whitespace-nowrap py-4 px-5 font-medium text-sm transition-all duration-300 relative z-10 flex items-center gap-2 tab-button"
                        :aria-current="activeTab === '{{ section.name }}' ? 'page' : null">
                    <span class="section-completion-badge" 
                          :class="sectionCompletion['{{ section.name }}'] === 100 ? 'complete' : sectionCompletion['{{ section.name }}'] > 0 ? 'partial' : 'empty'"
                          x-text="sectionCompletion['{{ section.name }}'] === 100 ? '✓' : sectionCompletion['{{ section.name }}'] > 0 ? '~' : '○'"></span>
                    {{ section.title }}
                    <span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full" x-show="sectionCompletion['{{ section.name }}'] > 0" x-text="getSectionCount('{{ section.name }}')"></span>
                </button>
                {% endfor %}
            </nav>
        </div>

        <div>
            <!-- Personal Details Panel -->
            <div x-show="activeTab === 'details'" 
                 x-cloak 
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 transform translate-y-4"
                 x-transition:enter-end="opacity-100 transform translate-y-0"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 transform translate-y-0"
                 x-transition:leave-end="opacity-0 transform translate-y-4"
                 id="personal-details-container">
                {% include 'resumes/partials/personal_details_section.html' %}
            </div>

            <!-- Dynamic Sections Panels -->
            {% for section in resume_sections %}
            <div x-show="activeTab === '{{ section.name }}'" 
                 x-cloak
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 transform translate-y-4"
                 x-transition:enter-end="opacity-100 transform translate-y-0"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 transform translate-y-0"
                 x-transition:leave-end="opacity-0 transform translate-y-4">
                {% include 'resumes/partials/dynamic_section.html' with section_name=section.name section_title=section.title form=section.form items=section.items %}
            </div>
            {% endfor %}
        </div>
        </div>
        
        <!-- Preview Action Bar -->
        <div class="mt-6 bg-white rounded-xl shadow-lg border border-gray-200 p-6" x-data="{ selectedTemplate: 'professional', selectedColor: 'indigo' }">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Preview & Download</h3>
                    <p class="text-sm text-gray-600">View your resume exactly as it will appear when printed</p>
                </div>
                
                <div class="flex flex-wrap items-center gap-3">
                    <!-- Template Selection -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700">Template:</label>
                        <select x-model="selectedTemplate" 
                                class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="classic">Classic</option>
                            <option value="modern">Modern</option>
                            <option value="professional">Professional</option>
                            <option value="creative">Creative</option>
                        </select>
                    </div>
                    
                    <!-- Color Selection -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-medium text-gray-700">Color:</label>
                        <select x-model="selectedColor" 
                                class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="blue">Blue</option>
                            <option value="teal">Teal</option>
                            <option value="indigo">Indigo</option>
                            <option value="purple">Purple</option>
                            <option value="red">Red</option>
                            <option value="graphite">Graphite</option>
                        </select>
                    </div>
                    
                    <!-- Preview Button -->
                    <a :href="`{% url 'resumes:preview-resume' resume_id=resume.id %}?template=${selectedTemplate}&accent_color=${selectedColor}`" 
                       target="_blank"
                       class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition-colors shadow-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                        Live Preview
                    </a>
                    
                    <!-- Download Button (AJAX with polling) -->
                    <a href="#"
                       @click.prevent="startPdfGeneration(selectedTemplate, selectedColor)"
                       class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-colors shadow-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Download PDF
                    </a>
                </div>
            </div>
        </div>
    </div>
    

    <!-- Delete Confirmation Modal -->
    <div x-show="confirmationModal.open" x-cloak x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed z-50 inset-0 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true"><div class="absolute inset-0 bg-gray-500 opacity-75"></div></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Delete Item</h3>
                            <div class="mt-2"><p class="text-sm text-gray-500">Are you sure you want to delete this item? This action cannot be undone.</p></div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="confirmDelete" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">Confirm Delete</button>
                    <button @click="confirmationModal.open = false" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pass resume data to JavaScript via script tag to avoid linter errors -->
<script type="application/json" id="resume-data">{"score":{% if score is not None %}{{ score }}{% else %}null{% endif %},"feedback":{% if feedback %}{{ feedback|safe }}{% else %}"[]"{% endif %}}</script>
<script type="application/json" id="section-completion-data">{
    "details": {% if resume.profile.full_name and resume.profile.professional_summary %}100{% else %}0{% endif %},
    {% for section in resume_sections %}
    "{{ section.name }}": {% if section.items|length > 0 %}100{% else %}0{% endif %}{% if not forloop.last %},{% endif %}
    {% endfor %}
}</script>

<script>
    // Initialize score and feedback from Django template
    // Parse from JSON script tag to avoid linter errors
    (function() {
        const dataScript = document.getElementById('resume-data');
        if (dataScript) {
            try {
                window._resumeData = JSON.parse(dataScript.textContent);
            } catch(e) {
                console.error('Error parsing resume data:', e);
                window._resumeData = { score: null, feedback: [] };
            }
        } else {
            window._resumeData = { score: null, feedback: [] };
        }
    })();
    
    function scoreChecker(resumeId) {
        // Get score and feedback from global object
        let initialScore = window._resumeData.score;
        let initialFeedback = window._resumeData.feedback;
        
        // Ensure feedback is an array
        if (!Array.isArray(initialFeedback)) {
            try {
                if (typeof initialFeedback === 'string' && initialFeedback !== '[]') {
                    initialFeedback = JSON.parse(initialFeedback);
                } else {
                    initialFeedback = [];
                }
            } catch(e) {
                console.error('Error parsing feedback:', e);
                initialFeedback = [];
            }
        }
        
        return {
            resumeId: resumeId, 
            score: initialScore, 
            feedback: initialFeedback, 
            isLoading: true, 
            chart: null,
            init() {
                // Ensure feedback is always an array
                if (!Array.isArray(this.feedback)) {
                    this.feedback = [];
                }
                
                // Always verify score with backend on page load, even if initial data exists
                // This ensures we have the latest score after page refresh
                const initializeScore = () => {
                    console.log('Initializing score checker. Initial score:', this.score, 'Initial feedback:', this.feedback);
                    
                    // Wait for Chart.js to be ready
                    const waitForChartJS = (attempts = 0) => {
                        if (typeof Chart !== 'undefined') {
                            console.log('Chart.js loaded, initializing score display');
                            
                            // Always check with backend first to ensure we have latest score
                            // Show initial score if available while checking
                            if (this.score !== null && this.score !== undefined) {
                                console.log('Initial score available, rendering chart');
                                this.isLoading = false;
                                // Render chart immediately with initial data
                                setTimeout(() => {
                                    this.renderChart();
                                }, 500);
                            } else {
                                console.log('No initial score, showing loading state');
                                this.isLoading = true;
                            }
                            
                            // Always verify with backend (this will update if score changed)
                            setTimeout(() => {
                                this.checkStatus();
                            }, 100);
                        } else if (attempts < 30) {
                            setTimeout(() => waitForChartJS(attempts + 1), 100);
                        } else {
                            console.error('Chart.js not loaded after 3 seconds, checking status anyway');
                            this.isLoading = false;
                            // Still check with backend even if Chart.js isn't loaded
                            this.checkStatus();
                        }
                    };
                    waitForChartJS();
                };
                
                // Wait for Alpine to be ready
                if (typeof Alpine !== 'undefined') {
                    initializeScore();
                } else {
                    document.addEventListener('alpine:init', () => {
                        initializeScore();
                    });
                    // Fallback if already initialized
                    setTimeout(() => {
                        if (typeof Alpine !== 'undefined') {
                            initializeScore();
                        }
                    }, 100);
                }
                
                // Listen for resume updates
                window.addEventListener('resume-updated', () => { 
                    this.isLoading = true; 
                    this.score = null; 
                    this.feedback = []; 
                    if (this.chart) { 
                        try {
                            this.chart.destroy(); 
                        } catch (e) {
                            console.warn('Error destroying chart on resume update:', e);
                        }
                        this.chart = null; 
                    }
                    this.checkStatus(); 
                });
            },
            renderChart() {
                if (this.score === null || this.score === undefined) {
                    console.log('Score is null/undefined, cannot render chart');
                    return;
                }
                
                // Destroy existing chart first to prevent conflicts
                if (this.chart) {
                    try {
                        this.chart.destroy();
                        this.chart = null;
                    } catch (e) {
                        console.warn('Error destroying chart:', e);
                        this.chart = null;
                    }
                }
                
                // Retry logic to ensure canvas is ready
                const tryRender = (attempts = 0) => {
                    const canvas = document.getElementById('score-chart');
                    if (!canvas) {
                        if (attempts < 10) {
                            setTimeout(() => tryRender(attempts + 1), 200);
                        } else {
                            console.error('Canvas element not found after multiple attempts');
                        }
                        return;
                    }
                    
                    // Check if Chart.js is loaded
                    if (typeof Chart === 'undefined') {
                        console.error('Chart.js is not loaded');
                        return;
                    }
                    
                    // Verify canvas is still in DOM and has context
                    if (!canvas.parentElement || !canvas.getContext) {
                        console.warn('Canvas element is not properly attached to DOM');
                        if (attempts < 5) {
                            setTimeout(() => tryRender(attempts + 1), 200);
                        }
                        return;
                    }
                    
                    // Wait a bit for canvas to be ready and ensure no other chart is being created
                    setTimeout(() => {
                        // Double-check canvas still exists and chart wasn't destroyed
                        const canvasCheck = document.getElementById('score-chart');
                        if (!canvasCheck || this.chart !== null) {
                            console.warn('Canvas not found or chart already exists, skipping render');
                            return;
                        }
                        
                        const score = parseInt(this.score) || 0;
                        const remaining = Math.max(0, 100 - score);
                        
                        const scoreColor = score >= 80 ? '#10b981' : score >= 60 ? '#3b82f6' : score >= 40 ? '#f59e0b' : '#ef4444';
                        
                        try {
                            // Get context and verify it's valid
                            const ctx = canvasCheck.getContext('2d');
                            if (!ctx) {
                                console.error('Could not get 2d context from canvas');
                                return;
                            }
                            
                            this.chart = new Chart(canvasCheck, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Score', 'Remaining'],
                                    datasets: [{
                                        data: [score, remaining],
                                        backgroundColor: [scoreColor, '#e5e7eb'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    cutout: '75%',
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: { enabled: false }
                                    },
                                    animation: {
                                        animateRotate: true,
                                        duration: 1500,
                                        onComplete: () => {
                                            // Chart animation complete
                                            console.log('Chart animation completed');
                                        }
                                    },
                                    // Prevent Chart.js from trying to update if canvas is removed
                                    onResize: (chart, size) => {
                                        if (!chart.canvas || !chart.canvas.parentElement) {
                                            console.warn('Canvas removed during resize, destroying chart');
                                            try {
                                                chart.destroy();
                                                this.chart = null;
                                            } catch (e) {
                                                // Ignore errors during cleanup
                                            }
                                        }
                                    }
                                },
                                plugins: [{
                                    id: 'centerText',
                                    beforeDraw: (chart) => {
                                        try {
                                            // Verify chart and canvas are still valid
                                            if (!chart || !chart.canvas || !chart.ctx) {
                                                return;
                                            }
                                            
                                            const ctx = chart.ctx;
                                            const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
                                            const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
                                            
                                            ctx.save();
                                            ctx.font = 'bold 42px Inter, system-ui, sans-serif';
                                            ctx.fillStyle = scoreColor;
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'middle';
                                            ctx.fillText(score.toString(), centerX, centerY);
                                            ctx.restore();
                                        } catch (e) {
                                            console.warn('Error in beforeDraw:', e);
                                        }
                                    }
                                }]
                            });
                            console.log('Chart rendered successfully with score:', score);
                        } catch (error) {
                            console.error('Error rendering chart:', error);
                            this.chart = null;
                        }
                    }, 200);
                };
                
                tryRender();
            },
            checkStatus(retryCount = 0) {
                const url = `/resumes/api/check-score-status/${this.resumeId}/`;
                console.log('Checking score status:', url, 'Retry:', retryCount);
                
                fetch(url, {
                    method: 'GET',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    cache: 'no-cache',
                    credentials: 'same-origin'
                })
                .then(res => {
                    if (!res.ok) {
                        console.error('Score status check failed:', res.status, res.statusText);
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('Score status response:', data.status, 'Score:', data.score);
                    if (data.status === 'SUCCESS') { 
                        // Always update score and feedback from backend
                        this.score = data.score; 
                        this.feedback = Array.isArray(data.feedback) ? data.feedback : (data.feedback || []); 
                        this.isLoading = false;
                        
                        console.log('Score updated:', this.score, 'Feedback count:', this.feedback.length);
                        
                        // Force re-render of chart if it exists or score changed
                        if (this.chart) {
                            try {
                                this.chart.destroy();
                            } catch (e) {
                                console.warn('Error destroying chart during update:', e);
                            }
                            this.chart = null;
                        }
                        
                        // Wait a bit before rendering to ensure DOM is stable
                        setTimeout(() => {
                            // Verify canvas still exists before rendering
                            const canvas = document.getElementById('score-chart');
                            if (canvas && canvas.parentElement) {
                                this.renderChart();
                            } else {
                                console.warn('Canvas not found or not in DOM, skipping chart render');
                            }
                        }, 400); 
                    } else if (data.status === 'PENDING') { 
                        // Keep checking if pending (with max retries to prevent infinite loops)
                        if (retryCount < 20) {
                            setTimeout(() => this.checkStatus(retryCount + 1), 3000);
                        } else {
                            console.warn('Score check timed out after 60 seconds');
                            this.isLoading = false;
                        }
                    } else { 
                        this.isLoading = false; 
                    } 
                })
                .catch(err => { 
                    console.error('Error checking score status:', err); 
                    // Retry with exponential backoff (max 3 retries)
                    if (retryCount < 3) {
                        const retryDelay = Math.pow(2, retryCount) * 2000; // 2s, 4s, 8s
                        setTimeout(() => this.checkStatus(retryCount + 1), retryDelay);
                    } else {
                        console.error('Failed to check score status after multiple retries');
                        this.isLoading = false;
                    }
                });
            },
            // Start PDF generation via JSON endpoint and poll until ready
            startPdfGeneration(template, color) {
                const startUrl = `{% url 'resumes:download-resume-pdf' resume_id=resume.id template_name='professional' %}`
                    .replace('/professional/', `/${template}/`) + `?accent_color=${color}&format=json`;
                const notify = (msg, type='info') => {
                    if (window.toast) {
                        if (type === 'error') window.toast.error(msg);
                        else if (type === 'success') window.toast.success(msg, 4000);
                        else window.toast.info ? window.toast.info(msg) : window.toast.success(msg, 3000);
                    }
                };
                fetch(startUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'pending' && data.pdf_generation_id) {
                            notify('PDF generation started. We will download it when it is ready.');
                            this.pollPdf(data.pdf_generation_id, 0);
                        } else {
                            // Fallback: if server returned a file directly (sync path), just navigate
                            window.location.href = startUrl.replace('&format=json','');
                        }
                    })
                    .catch(err => {
                        console.error('Error starting PDF generation:', err);
                        notify('Could not start PDF generation. Please try again.', 'error');
                    });
            },
            pollPdf(pdfId, attempt) {
                const url = `{% url 'resumes:check-pdf-status' pdf_generation_id=0 %}`.replace('/0/', `/${pdfId}/`);
                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'completed' && data.download_url) {
                            if (window.toast) window.toast.success('PDF ready. Downloading...', 3000);
                            // Trigger browser download
                            window.location.href = `{% url 'resumes:download-generated-pdf' pdf_generation_id=0 %}`.replace('/0/', `/${pdfId}/`);
                        } else if (data.status === 'failed') {
                            if (window.toast) window.toast.error(data.error || 'PDF generation failed.');
                        } else {
                            if (attempt < 40) {
                                setTimeout(() => this.pollPdf(pdfId, attempt + 1), 3000);
                            } else {
                                if (window.toast) window.toast.error('PDF generation is taking too long. Please try again later.');
                            }
                        }
                    })
                    .catch(err => {
                        console.error('Error checking PDF status:', err);
                        if (attempt < 5) {
                            setTimeout(() => this.pollPdf(pdfId, attempt + 1), 5000);
                        } else if (window.toast) {
                            window.toast.error('Could not check PDF status.');
                        }
                    });
            }
        }
    }

    // Initialize section completion data from JSON script tag
    (function() {
        const completionScript = document.getElementById('section-completion-data');
        if (completionScript) {
            try {
                window._sectionCompletionData = JSON.parse(completionScript.textContent);
            } catch(e) {
                console.error('Error parsing section completion data:', e);
                window._sectionCompletionData = {};
            }
        } else {
            window._sectionCompletionData = {};
        }
    })();
    
    function tabNavigation(resumeId) {
        // Get initial completion data from global object
        const initialCompletion = window._sectionCompletionData || {};
        
        return {
            activeTab: 'details',
            tabIndicatorStyle: '',
            sectionCompletion: {
                details: initialCompletion.details || 0,
                experience: initialCompletion.experience || 0,
                education: initialCompletion.education || 0,
                skill: initialCompletion.skill || 0,
                project: initialCompletion.project || 0,
                certification: initialCompletion.certification || 0,
                achievement: initialCompletion.achievement || 0,
                language: initialCompletion.language || 0,
                hobby: initialCompletion.hobby || 0,
            },
            init() {
                this.updateTabIndicator();
                // Update completion on resume updates
                window.addEventListener('resume-updated', () => {
                    this.updateSectionCompletion();
                });
            },
            switchTab(tab) {
                this.activeTab = tab;
                this.updateTabIndicator();
                // Smooth scroll to top of content
                const content = document.querySelector('[x-show*="tab"]');
                if (content) {
                    content.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            },
            updateTabIndicator() {
                this.$nextTick(() => {
                    const activeButton = document.querySelector(`[aria-current="page"]`);
                    if (activeButton) {
                        const rect = activeButton.getBoundingClientRect();
                        const nav = activeButton.closest('nav');
                        const navRect = nav.getBoundingClientRect();
                        this.tabIndicatorStyle = `left: ${rect.left - navRect.left}px; width: ${rect.width}px;`;
                    }
                });
            },
            getSectionCount(sectionName) {
                const container = document.getElementById(`items-container-${sectionName}`);
                if (container) {
                    const items = container.querySelectorAll('[id^="item-"]');
                    return items.length;
                }
                return 0;
            },
            updateSectionCompletion() {
                // Calculate completion percentages
                const detailsSection = document.getElementById('personal-details-container');
                if (detailsSection) {
                    const hasName = !!detailsSection.querySelector('[data-field="full_name"]')?.textContent?.trim();
                    const hasSummary = !!detailsSection.querySelector('[data-field="summary"]')?.textContent?.trim();
                    this.sectionCompletion.details = (hasName && hasSummary) ? 100 : (hasName || hasSummary) ? 50 : 0;
                }
                
                // Update completion for all dynamic sections
                const sectionNames = ['experience', 'education', 'skill', 'project', 'certification', 'achievement', 'language', 'hobby'];
                sectionNames.forEach(sectionName => {
                    const container = document.getElementById(`items-container-${sectionName}`);
                    if (container) {
                        const items = container.querySelectorAll('[id^="item-"]');
                        this.sectionCompletion[sectionName] = items.length > 0 ? 100 : 0;
                    }
                });
                
                this.updateTabIndicator();
            }
        }
    }

    function resumeBuilder() {
        return {
            confirmationModal: { open: false, itemToDelete: null },
            lastSaveTime: null,
            autoSaveTimer: null,
            originalTextBuffer: {},  // Store original text before AI enhancement

            formatSectionName(name) {
                if (!name) return 'Item';
                return name.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
            },

            showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                if (!toastContainer) return;

                const toastId = 'toast-' + Date.now();
                const borderColor = type === 'success' ? 'border-green-400' : 'border-red-400';
                const iconSvg = type === 'success' ? 
                    `<svg class="h-6 w-6 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>` :
                    `<svg class="h-6 w-6 text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;

                const toastHtml = `
                    <div id="${toastId}" class="toast-message max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden" style="transform: translateX(120%); transition: transform 0.5s ease-in-out;">
                        <div class="p-4 border-l-4 ${borderColor}">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">${iconSvg}</div>
                                <div class="ml-3 w-0 flex-1 pt-0.5"><p class="text-sm font-medium text-gray-900">${message}</p></div>
                            </div>
                        </div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                const toast = document.getElementById(toastId);

                setTimeout(() => { toast.style.transform = 'translateX(0)'; }, 100);
                setTimeout(() => { toast.style.transform = 'translateX(120%)'; setTimeout(() => toast.remove(), 500); }, 4000);
            },
            handleFormSubmit(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const sectionName = form.dataset.section;
                const submitButton = form.querySelector('button[type="submit"]');
                const originalText = submitButton?.textContent;
                
                // Disable submit button and show loading
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Adding...';
                }
                
                fetch(form.getAttribute('action'), { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(res => res.json())
                .then(data => {
                        if (data.status === 'success') {
                        const container = document.getElementById(`items-container-${sectionName}`);
                        if (container) {
                            const newItem = document.createElement('div');
                            newItem.innerHTML = data.item_html;
                            const itemEl = newItem.firstElementChild;
                            itemEl.style.opacity = '0';
                            itemEl.style.transform = 'translateY(-10px) scale(0.95)';
                            container.appendChild(itemEl);
                            document.getElementById(`empty-message-${sectionName}`)?.remove();
                            
                            // Enhanced animate in with bounce
                            requestAnimationFrame(() => {
                                itemEl.style.transition = 'opacity 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                                itemEl.style.opacity = '1';
                                itemEl.style.transform = 'translateY(0) scale(1)';
                            });
                        }
                        form.reset();
                        window.dispatchEvent(new CustomEvent('resume-updated'));
                        // Update section completion
                        if (window.tabNavigationInstance) {
                            window.tabNavigationInstance.updateSectionCompletion();
                        }
                        this.showToast(`${this.formatSectionName(sectionName)} added successfully!`, 'success');
                    } else { 
                        this.displayErrors(form, data.errors); 
                        this.showToast('Please correct the errors.', 'error');
                    }
                }).catch(err => {
                    console.error('Form submission error:', err);
                    this.showToast('An unexpected error occurred.', 'error');
                })
                .finally(() => {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    }
                });
            },
            editItem(event) {
                const button = event.currentTarget;
                const pk = button.dataset.pk;
                const sectionName = button.dataset.section;
                const container = (sectionName === 'personal_details') ? document.getElementById('personal-details-container') : document.getElementById(`item-${sectionName}-${pk}`);
                
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                formData.append('action', 'get_edit_form');
                formData.append('model_name', sectionName);
                formData.append('pk', pk);

                fetch("{% url 'resumes:resume-builder' %}", { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(res => res.json())
                .then(data => { if (data.status === 'success') { container.innerHTML = data.form_html; } })
                .catch(err => console.error('Error getting edit form:', err));
            },
            handleUpdateSubmit(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const sectionName = form.dataset.section;
                const submitButton = form.querySelector('button[type="submit"]');
                const originalText = submitButton?.textContent;
                
                // Disable submit button and show loading
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Saving...';
                }
                
                fetch(form.getAttribute('action'), { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        const container = (sectionName === 'personal_details') ? document.getElementById('personal-details-container') : document.getElementById(`item-${sectionName}-${data.pk}`);
                        if (container) {
                            // Enhanced fade transition with scale
                            container.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                            container.style.opacity = '0.5';
                            container.style.transform = 'scale(0.98)';
                            requestAnimationFrame(() => {
                                container.innerHTML = data.item_html;
                                container.style.opacity = '1';
                                container.style.transform = 'scale(1)';
                            });
                        }
                        if (data.new_title) { document.getElementById('resume-title').textContent = data.new_title; }
                        window.dispatchEvent(new CustomEvent('resume-updated'));
                        // Update section completion
                        if (window.tabNavigationInstance) {
                            window.tabNavigationInstance.updateSectionCompletion();
                        }
                        this.showToast(`${this.formatSectionName(sectionName)} updated successfully!`, 'success');
                    } else { 
                        this.displayErrors(form, data.errors); 
                        this.showToast('Failed to save. Please check the errors.', 'error');
                    }
                }).catch(err => {
                    console.error('Update submission error:', err);
                    this.showToast('An unexpected error occurred.', 'error');
                })
                .finally(() => {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.textContent = originalText;
                    }
                });
            },
            cancelEdit(pk, sectionName) {
                const container = (sectionName === 'personal_details') ? 
                    document.getElementById('personal-details-container') : 
                    document.getElementById(`item-${sectionName}-${pk}`);
                
                if (!container) {
                    console.error('Container not found for cancelEdit');
                    return;
                }

                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                formData.append('action', 'get_item_html');
                formData.append('model_name', sectionName);
                formData.append('pk', pk);

                fetch("{% url 'resumes:resume-builder' %}", {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        container.innerHTML = data.item_html;
                    } else {
                        console.error('Error getting item HTML:', data);
                    }
                })
                .catch(err => {
                    console.error('Error canceling edit:', err);
                    this.showToast('Failed to cancel edit.', 'error');
                });
            },
            deleteItem(event) {
                const button = event.currentTarget;
                this.confirmationModal.itemToDelete = {
                    pk: button.dataset.pk,
                    sectionName: button.dataset.section
                };
                this.confirmationModal.open = true;
            },
            confirmDelete() {
                const { pk, sectionName } = this.confirmationModal.itemToDelete;
                const itemDiv = document.getElementById(`item-${sectionName}-${pk}`);
                if (!itemDiv) {
                    this.confirmationModal.open = false;
                    return;
                }
                
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                formData.append('action', 'delete');
                formData.append('model_name', sectionName);
                formData.append('pk', pk);

                fetch("{% url 'resumes:resume-builder' %}", { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(async res => {
                    const data = await res.json();
                    if (!res.ok) {
                        throw new Error(data.message || `Server error: ${res.status}`);
                    }
                    return data;
                })
                .then(data => {
                    if (data.status === 'success') { 
                        // Smooth fade out animation
                        itemDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease, margin 0.3s ease';
                        itemDiv.style.opacity = '0';
                        itemDiv.style.transform = 'translateX(-20px)';
                        setTimeout(() => {
                            if (itemDiv && itemDiv.parentNode) {
                                itemDiv.remove();
                            }
                            window.dispatchEvent(new CustomEvent('resume-updated'));
                            this.showToast(`${this.formatSectionName(sectionName)} deleted successfully!`, 'success');
                        }, 300);
                    } else {
                        const errorMsg = data.message || 'Failed to delete item.';
                        this.showToast(errorMsg, 'error');
                    } 
                })
                .catch(err => {
                    console.error('Delete error:', err);
                    let errorMsg = 'Failed to delete item.';
                    
                    // Extract error message if available
                    if (err.message) {
                        errorMsg = err.message;
                    } else if (err instanceof TypeError && err.message.includes('fetch')) {
                        errorMsg = 'Network error. Please check your connection and try again.';
                    } else {
                        errorMsg = 'An unexpected error occurred while deleting the item.';
                    }
                    
                    this.showToast(errorMsg, 'error');
                })
                .finally(() => {
                    this.confirmationModal.open = false;
                    this.confirmationModal.itemToDelete = null;
                });
            },
            enhanceText(event) {
                const button = event.currentTarget;
                const form = button.closest('form');
                const context = button.dataset.context;
                const targetTextarea = form.querySelector(`textarea[name="${button.dataset.target}"]`);

                if (!targetTextarea || !targetTextarea.value) { this.showToast('Please enter some text to enhance.', 'error'); return; }
                
                // Store original text before enhancement
                const textareaId = targetTextarea.id || targetTextarea.name;
                this.originalTextBuffer[textareaId] = targetTextarea.value;
                
                const originalText = button.innerHTML;
                button.innerHTML = 'Enhancing...'; button.disabled = true;

                fetch("{% url 'resumes:enhance-api' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ text: targetTextarea.value, context: context })
                })
                .then(res => res.json())
                .then(data => { 
                    if (data.enhanced_text) { 
                        targetTextarea.value = data.enhanced_text; 
                        this.showToast('Text enhanced successfully!', 'success');
                        // Trigger update to show undo button
                        targetTextarea.dispatchEvent(new Event('input'));
                    } else { 
                        this.showToast(data.error || 'An error occurred.', 'error');
                    } 
                })
                .catch(err => {
                    console.error('Enhance API error:', err);
                    this.showToast('An unexpected error occurred during enhancement.', 'error');
                })
                .finally(() => { button.innerHTML = originalText; button.disabled = false; });
            },
            undoEnhance(targetId) {
                // Try multiple possible IDs/names
                const possibleIds = [targetId, `id_${targetId}`, targetId.replace('id_', '')];
                let targetTextarea = null;
                let bufferKey = null;
                
                for (const id of possibleIds) {
                    targetTextarea = document.getElementById(id) || document.querySelector(`textarea[name="${id}"]`);
                    if (targetTextarea) {
                        // Check if we have a buffer entry for this field
                        bufferKey = Object.keys(this.originalTextBuffer).find(key => 
                            key === id || key === `id_${id}` || key === id.replace('id_', '')
                        );
                        if (bufferKey) break;
                    }
                }
                
                if (targetTextarea && bufferKey && this.originalTextBuffer[bufferKey]) {
                    targetTextarea.value = this.originalTextBuffer[bufferKey];
                    delete this.originalTextBuffer[bufferKey];
                    this.showToast('Text reverted to original.', 'success');
                    // Trigger update to hide undo button
                    targetTextarea.dispatchEvent(new Event('input'));
                }
            },
            hasUndoBuffer(fieldName) {
                // Check if we have an undo buffer for this field
                const possibleKeys = [fieldName, `id_${fieldName}`, fieldName.replace('id_', '')];
                return possibleKeys.some(key => this.originalTextBuffer[key] !== undefined);
            },
            displayErrors(form, errors) {
                form.querySelectorAll('.error-message').forEach(el => el.remove());
                form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

                for (const field in errors) {
                    const input = form.querySelector(`[name="${field}"]`);
                    if (input) {
                        input.classList.add('is-invalid');
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'text-red-600 text-sm mt-1 error-message';
                        errorDiv.textContent = errors[field][0];
                        input.parentNode.appendChild(errorDiv);
                    }
                }
            }
        }
    }
    

    document.addEventListener('alpine:init', () => {
        Alpine.data('scoreChecker', scoreChecker);
        Alpine.data('resumeBuilder', resumeBuilder);
        Alpine.data('tabNavigation', tabNavigation);
        
        // Scroll to personal details section if hash is present
        if (window.location.hash === '#personal-details') {
            setTimeout(() => {
                const personalDetailsSection = document.getElementById('personal-details');
                if (personalDetailsSection) {
                    personalDetailsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // Highlight the section briefly
                    personalDetailsSection.style.transition = 'box-shadow 0.3s ease';
                    personalDetailsSection.style.boxShadow = '0 0 0 4px rgba(99, 102, 241, 0.3)';
                    setTimeout(() => {
                        personalDetailsSection.style.boxShadow = '';
                    }, 2000);
                }
            }, 500);
        }
        
        // Store tab navigation instance globally for updates
        setTimeout(() => {
            const tabNavElement = document.querySelector('[x-data*="tabNavigation"]');
            if (tabNavElement && tabNavElement._x_dataStack) {
                window.tabNavigationInstance = tabNavElement._x_dataStack[0];
            }
        }, 500);
    });
</script>
{% endblock %}

