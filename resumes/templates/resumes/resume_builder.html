{% extends 'base.html' %}
{% load crispy_forms_tags resume_extras %}

{% block title %}AI Resume Builder{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-10 px-4 sm:px-6 lg:px-8" x-data="resumeBuilder()">
    
    <header class="mb-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <h1 id="resume-title" class="text-3xl font-bold tracking-tight text-gray-900">{{ resume.title }}</h1>
            <div class="flex items-center gap-2 flex-shrink-0" x-data="{ open: false }">
                <button @click="open = !open" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
                    Download PDF
                    <svg class="ml-2 -mr-1 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                </button>
                <div x-show="open" @click.away="open = false" x-cloak class="origin-top-right absolute right-4 mt-40 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                    <div class="py-1" role="none">
                        <a href="{% url 'resumes:download-resume-pdf' resume_id=resume.id template_name='classic' %}" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100">Classic Template</a>
                        <a href="{% url 'resumes:download-resume-pdf' resume_id=resume.id template_name='modern' %}" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100">Modern Template</a>
                        <a href="{% url 'resumes:download-resume-pdf' resume_id=resume.id template_name='professional' %}" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100">Professional Template</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- AI Score & Feedback -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-10 border-l-4 border-indigo-500" x-data="scoreChecker({{ resume.id }})" x-init="init()">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">AI Score & Feedback</h2>
        <div x-show="isLoading" x-cloak class="flex items-center gap-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            <div><p class="font-semibold text-gray-700">AI analysis in progress...</p><p class="text-sm text-gray-500">Your score and feedback will appear here shortly.</p></div>
        </div>
        <div x-show="!isLoading" x-cloak x-transition class="flex items-start gap-6">
            <div class="flex-shrink-0 flex flex-col items-center justify-center bg-indigo-100 rounded-full w-28 h-28">
                <span x-text="score" class="text-4xl font-bold text-indigo-700"></span>
                <span class="text-sm text-indigo-600">out of 100</span>
            </div>
            <div>
                <h3 class="font-semibold text-gray-700">Actionable Suggestions:</h3>
                <ul class="list-disc list-inside mt-2 text-gray-600 space-y-2 prose prose-sm">
                    <template x-for="item in feedback" :key="item"><li x-text="item"></li></template>
                    <template x-if="!feedback || feedback.length === 0"><li>No feedback available.</li></template>
                </ul>
            </div>
        </div>
    </div>

    <!-- Tabbed Interface Container -->
    <div x-data="{ tab: 'details' }">
        <div class="mb-8 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                <button @click="tab = 'details'" :class="{ 'border-indigo-500 text-indigo-600': tab === 'details', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': tab !== 'details' }" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Personal Details</button>
                {% for section in resume_sections %}
                <button @click="tab = '{{ section.name }}'" :class="{ 'border-indigo-500 text-indigo-600': tab === '{{ section.name }}', 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300': tab !== '{{ section.name }}' }" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">{{ section.title }}</button>
                {% endfor %}
            </nav>
        </div>

        <div>
            <!-- Personal Details Panel -->
            <div x-show="tab === 'details'" x-cloak id="personal-details-container">
                {% include 'resumes/partials/personal_details_section.html' %}
            </div>

            <!-- Dynamic Sections Panels -->
            {% for section in resume_sections %}
            <div x-show="tab === '{{ section.name }}'" x-cloak>
                {% include 'resumes/partials/dynamic_section.html' with section_name=section.name section_title=section.title form=section.form items=section.items %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div x-show="confirmationModal.open" x-cloak x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" class="fixed z-50 inset-0 overflow-y-auto">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true"><div class="absolute inset-0 bg-gray-500 opacity-75"></div></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Delete Item</h3>
                            <div class="mt-2"><p class="text-sm text-gray-500">Are you sure you want to delete this item? This action cannot be undone.</p></div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="confirmDelete" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm">Confirm Delete</button>
                    <button @click="confirmationModal.open = false" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function scoreChecker(resumeId) {
        return {
            resumeId: resumeId, score: {{ score|default:'null' }}, feedback: JSON.parse('{{ feedback|escapejs|default:"[]" }}'), isLoading: true,
            init() { this.score !== null ? this.isLoading = false : this.checkStatus(); window.addEventListener('resume-updated', () => { this.isLoading = true; this.score = null; this.feedback = []; this.checkStatus(); }); },
            checkStatus() {
                fetch(`/resumes/api/check-score-status/${this.resumeId}/`).then(res => res.json()).then(data => {
                    if (data.status === 'SUCCESS') { this.isLoading = false; this.score = data.score; this.feedback = data.feedback; } 
                    else { setTimeout(() => this.checkStatus(), 5000); }
                }).catch(err => { console.error('Error checking score status:', err); setTimeout(() => this.checkStatus(), 5000); });
            }
        }
    }

    function resumeBuilder() {
        return {
            confirmationModal: { open: false, itemToDelete: null },

            formatSectionName(name) {
                if (!name) return 'Item';
                return name.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
            },

            showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toast-container');
                if (!toastContainer) return;

                const toastId = 'toast-' + Date.now();
                const borderColor = type === 'success' ? 'border-green-400' : 'border-red-400';
                const iconSvg = type === 'success' ? 
                    `<svg class="h-6 w-6 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>` :
                    `<svg class="h-6 w-6 text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;

                const toastHtml = `
                    <div id="${toastId}" class="toast-message max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden" style="transform: translateX(120%); transition: transform 0.5s ease-in-out;">
                        <div class="p-4 border-l-4 ${borderColor}">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">${iconSvg}</div>
                                <div class="ml-3 w-0 flex-1 pt-0.5"><p class="text-sm font-medium text-gray-900">${message}</p></div>
                            </div>
                        </div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                const toast = document.getElementById(toastId);

                setTimeout(() => { toast.style.transform = 'translateX(0)'; }, 100);
                setTimeout(() => { toast.style.transform = 'translateX(120%)'; setTimeout(() => toast.remove(), 500); }, 4000);
            },
            handleFormSubmit(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const sectionName = form.dataset.section;
                
                fetch(form.getAttribute('action'), { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById(`items-container-${sectionName}`).insertAdjacentHTML('beforeend', data.item_html);
                        document.getElementById(`empty-message-${sectionName}`)?.remove();
                        form.reset();
                        window.dispatchEvent(new CustomEvent('resume-updated'));
                        this.showToast(`${this.formatSectionName(sectionName)} added successfully!`, 'success');
                    } else { 
                        this.displayErrors(form, data.errors); 
                        this.showToast('Please correct the errors.', 'error');
                    }
                }).catch(err => {
                    console.error('Form submission error:', err);
                    this.showToast('An unexpected error occurred.', 'error');
                });
            },
            editItem(event) {
                const button = event.currentTarget;
                const pk = button.dataset.pk;
                const sectionName = button.dataset.section;
                const container = (sectionName === 'personal_details') ? document.getElementById('personal-details-container') : document.getElementById(`item-${sectionName}-${pk}`);
                
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                formData.append('action', 'get_edit_form');
                formData.append('model_name', sectionName);
                formData.append('pk', pk);

                fetch("{% url 'resumes:resume-builder' %}", { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(res => res.json())
                .then(data => { if (data.status === 'success') { container.innerHTML = data.form_html; } })
                .catch(err => console.error('Error getting edit form:', err));
            },
            handleUpdateSubmit(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const sectionName = form.dataset.section;
                
                fetch(form.getAttribute('action'), { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        const container = (sectionName === 'personal_details') ? document.getElementById('personal-details-container') : document.getElementById(`item-${sectionName}-${data.pk}`);
                        container.innerHTML = data.item_html;
                        if (data.new_title) { document.getElementById('resume-title').textContent = data.new_title; }
                        window.dispatchEvent(new CustomEvent('resume-updated'));
                        this.showToast(`${this.formatSectionName(sectionName)} updated successfully!`, 'success');
                    } else { 
                        this.displayErrors(form, data.errors); 
                        this.showToast('Failed to save. Please check the errors.', 'error');
                    }
                }).catch(err => {
                    console.error('Update submission error:', err);
                    this.showToast('An unexpected error occurred.', 'error');
                });
            },
            cancelEdit(pk, sectionName) {
                window.location.reload();
            },
            deleteItem(event) {
                const button = event.currentTarget;
                this.confirmationModal.itemToDelete = {
                    pk: button.dataset.pk,
                    sectionName: button.dataset.section
                };
                this.confirmationModal.open = true;
            },
            confirmDelete() {
                const { pk, sectionName } = this.confirmationModal.itemToDelete;
                const itemDiv = document.getElementById(`item-${sectionName}-${pk}`);
                
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                formData.append('action', 'delete');
                formData.append('model_name', sectionName);
                formData.append('pk', pk);

                fetch("{% url 'resumes:resume-builder' %}", { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') { 
                        itemDiv.style.transition = 'opacity 0.3s';
                        itemDiv.style.opacity = '0';
                        setTimeout(() => itemDiv.remove(), 300);
                        window.dispatchEvent(new CustomEvent('resume-updated'));
                        this.showToast(`${this.formatSectionName(sectionName)} deleted successfully!`, 'success');
                    } 
                }).catch(err => {
                    console.error('Delete error:', err);
                    this.showToast('Failed to delete item.', 'error');
                })
                .finally(() => {
                    this.confirmationModal.open = false;
                    this.confirmationModal.itemToDelete = null;
                });
            },
            enhanceText(event) {
                const button = event.currentTarget;
                const form = button.closest('form');
                const context = button.dataset.context;
                const targetTextarea = form.querySelector(`textarea[name="${button.dataset.target}"]`);

                if (!targetTextarea || !targetTextarea.value) { this.showToast('Please enter some text to enhance.', 'error'); return; }
                
                const originalText = button.innerHTML;
                button.innerHTML = 'Enhancing...'; button.disabled = true;

                fetch("{% url 'resumes:enhance-api' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ text: targetTextarea.value, context: context })
                })
                .then(res => res.json())
                .then(data => { 
                    if (data.enhanced_text) { 
                        targetTextarea.value = data.enhanced_text; 
                        this.showToast('Text enhanced successfully!', 'success');
                    } else { 
                        this.showToast(data.error || 'An error occurred.', 'error');
                    } 
                })
                .catch(err => {
                    console.error('Enhance API error:', err);
                    this.showToast('An unexpected error occurred during enhancement.', 'error');
                })
                .finally(() => { button.innerHTML = originalText; button.disabled = false; });
            },
            displayErrors(form, errors) {
                form.querySelectorAll('.error-message').forEach(el => el.remove());
                form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

                for (const field in errors) {
                    const input = form.querySelector(`[name="${field}"]`);
                    if (input) {
                        input.classList.add('is-invalid');
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'text-red-600 text-sm mt-1 error-message';
                        errorDiv.textContent = errors[field][0];
                        input.parentNode.appendChild(errorDiv);
                    }
                }
            }
        }
    }
    
    document.addEventListener('alpine:init', () => {
        Alpine.data('scoreChecker', scoreChecker);
        Alpine.data('resumeBuilder', resumeBuilder);
    });
</script>
{% endblock %}

